<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eco Track Solid Waste Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: { DEFAULT: '#10b981', light: '#34d399', dark: '#059669' },
              accent: { DEFAULT: '#22d3ee', dark: '#06b6d4' },
              secondary: { DEFAULT: '#64748b', dark: '#94a3b8' },
              background: { light: '#f8fafc', dark: '#020617' },
              card: { light: '#ffffff', dark: '#1e293b' },
              text: { light: '#475569', dark: '#cbd5e1' },
              heading: { light: '#1e293b', dark: '#f1f5f9' },
              border: { light: '#e2e8f0', dark: '#334155' },
              success: '#22c55e',
              danger: '#ef4444',
              warning: '#f59e0b',
              info: '#3b82f6',
            },
            boxShadow: {
                'glow-primary': '0 0 15px 0 rgba(16, 185, 129, 0.4)',
                'glow-accent': '0 0 15px 0 rgba(34, 211, 238, 0.4)',
            },
            keyframes: {
              'fade-in': { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              'fade-in-down': { '0%': { opacity: '0', transform: 'translateY(-10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
              'fade-in-up': { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
              'scale-in': { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
              'pulse-glow': { '0%, 100%': { opacity: '1', boxShadow: 'none' }, '50%': { opacity: '0.9', boxShadow: '0 0 15px 0 rgba(16, 185, 129, 0.5)' } },
              'gradient-pan': { '0%': { 'background-position': '0% 50%' }, '50%': { 'background-position': '100% 50%' }, '100%': { 'background-position': '0% 50%' } },
              'background-pan': { '0%': { backgroundPosition: '0% 50%' }, '50%': { backgroundPosition: '100% 50%' }, '100%': { backgroundPosition: '0% 50%' } },
            },
            animation: {
              'fade-in': 'fade-in 0.5s ease-out forwards',
              'fade-in-down': 'fade-in-down 0.5s ease-out forwards',
              'fade-in-up': 'fade-in-up 0.5s ease-out forwards',
              'scale-in': 'scale-in 0.3s ease-out forwards',
              'pulse-glow': 'pulse-glow 2s infinite ease-in-out',
              'gradient-pan': 'gradient-pan 4s ease-in-out infinite',
              'background-pan': 'background-pan 15s ease infinite',
            },
            backgroundSize: { '300': '300% 300%', '400': '400% 400%' },
          },
        },
      }
    </script>
    <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-background-light dark:bg-background-dark transition-colors duration-300">
    <div id="app-root"></div>
    <div id="modal-container"></div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.25.0"
      }
    }
    </script>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        document.addEventListener('DOMContentLoaded', () => {
            const appRoot = document.getElementById('app-root');
            if (!appRoot) return;

            // =================================================================
            // 1. TYPES, CONSTANTS & ENUMS
            // =================================================================
            let resendInterval = null;
            let locationWatchId = null;

            const ViewType = {
                Dashboard: 'Dashboard', Payment: 'Payment', History: 'History', Complaints: 'Complaints',
                Education: 'Education', Booking: 'Booking', Profile: 'Profile', Messages: 'Messages',
                Track: 'Track', Sell: 'Sell'
            };

            const AdminView = {
                Dashboard: 'dashboard', Users: 'users', Bookings: 'bookings',
                SellRequests: 'sell-requests', Complaints: 'complaints', Payments: 'payments', Broadcast: 'broadcast',
                Employees: 'employees', Captains: 'captains', SanitaryWorkers: 'sanitaryworkers',
                AIManagement: 'ai-management', SubscriptionManagement: 'subscription-management',
                IPTracker: 'ip-tracker', StaffNotice: 'staff-notice'
            };
            
            const StaffView = { Dashboard: 'dashboard', Profile: 'profile' };

            const GRAM_PANCHAYATS = ['ANDAL', 'DAKSHINKHANDA', 'KAJORA', 'KHANDRA', 'MADANPUR', 'RAMPRASADPUR', 'SHRIRAMPUR', 'UKHRA'];
            
            const NGO_NAME = "Andal Gray to Green";
            const UPI_ID = "suryalaha@upi";
            const SUPPORT_PHONE_NUMBER = "9635929052";
            const SUPPORT_EMAIL = "shyantanbiswas7@gmail.com";
            
            const generateUpiUrl = (amount, note) => {
                const noteParam = note ? `&tn=${encodeURIComponent(note)}` : '';
                return `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(NGO_NAME)}&am=${amount.toFixed(2)}&cu=INR${noteParam}`;
            };
            
            // =================================================================
            // 2. TRANSLATIONS
            // =================================================================
            const translations = {
                en: {
                    "welcome": "Welcome", "welcomeUser": "Welcome, {{name}}!", "home": "Home", "pay": "Pay", "inbox": "Inbox",
                    "book": "Book", "history": "History", "profile": "Profile", "track": "Track", "sell": "Sell", "dashboardTitle": "Welcome, {{name}}!",
                    "balance": "Balance", "pendingBalance": "Pending balance.", "allSettled": "All settled.", "cleared": "Cleared!",
                    "loginStreak": "Login Streak", "daysInARow": "{{count}} day in a row!", "daysInARow_plural": "{{count}} days in a row!",
                    "reminder": "Reminder", "liveCollectionStatus": "Live Collection Status", "viewOnMap": "View on Map",
                    "noActiveVehicle": "No collection vehicle is currently active in your area.", "communityWasteDiversion": "Community Waste Diversion",
                    "total": "total", "recycled": "Recycled", "composted": "Composted", "landfill": "Landfill", "co2Saved": "Total CO₂ Saved: {{amount}} Tons",
                    "chooseLogin": "Choose Your Login", "householdLogin": "Household Login", "staffLogin": "Staff Login", "adminLogin": "Admin Login",
                    "welcomeBack": "Welcome Back!", "mobileNumber": "Mobile Number", "emailAddress": "Email Address", "password": "Password",
                    "rememberMe": "Remember me", "login": "Login", "forgotPassword": "Forgot password? Please contact the administrator for assistance.",
                    "createAccount": "Create Account", "fullName": "Full Name", "confirmPassword": "Confirm Password", "next": "Next",
                    "yourDetails": "Your Details", "familyMembers": "No. of Family Members", "area": "Area / Locality", "landmark": "Nearest Landmark",
                    "pincode": "Area Pincode", "completeSignup": "Complete Sign Up", "back": "Back", "verification": "Verification",
                    "adminVerification": "Enter the administrator mobile number.", "sendOtp": "Send OTP", "verifyOtp": "Verify OTP",
                    "otpSentTo": "OTP sent for {{identifier}}.", "change": "Change", "otpPlaceholder": "6-digit OTP",
                    "verifyAndProceed": "Verify & Proceed", "resendOtp": "Resend OTP", "resendOtpIn": "Resend in {{count}}s",
                    "staffVerification": "Enter your registered mobile number.", "yourRole": "Your Role", "role_captain": "Captain",
                    "role_employee": "Employee", "role_sanitaryworker": "Sanitary Worker", "staffNotice": "Staff Notice",
                    "aMessageForYou": "A Message for You", "sendNoticeToStaff": "Send a Notice to All Staff",
                    "staffNoticeDescription": "This message will be shown as a pop-up to all staff members when they log in.",
                    "updateNotice": "Update Notice", "noticeUpdated": "Notice Updated!", "securityAlert": "Security Alert",
                    "weakPasswordWarning": "Your current password is weak. For your security, please create a new, stronger password.",
                    "changePassword": "Change Password", "currentPassword": "Current Password", "newPassword": "New Password",
                    "confirmNewPassword": "Confirm New Password", "passwordChangedSuccess": "Password changed successfully!",
                    "passwordMismatchError": "New passwords do not match.", "incorrectCurrentPasswordError": "Incorrect current password.",
                    "pw8Chars": "8+ Characters", "pwUppercase": "Uppercase", "pwLowercase": "Lowercase", "pwNumber": "Number",
                    "pwSpecial": "Special", "mySellRequests": "My Sell Requests", "noSellRequests": "You have not made any requests to sell materials yet.",
                    "chatWithAdmin": "Chat with Admin", "complaints": "Complaints", "submitComplaint": "Submit a Complaint", "issueType": "Issue Type",
                    "details": "Details", "submit": "Submit", "myComplaints": "My Complaints", "noComplaints": "You haven't filed any complaints yet.",
                    "bookECart": "Book an E-Cart", "bookECartDesc": "For special waste collection like bulk or e-waste.", "wasteType": "Waste Type",
                    "date": "Date", "timeSlot": "Time Slot", "notes": "Additional Notes (optional)", "bookNow": "Book Now", "myBookings": "My Bookings",
                    "noBookings": "You haven't made any bookings yet.", "personalDetails": "Personal Details", "editProfile": "Edit Profile",
                    "faq": "Frequently Asked Questions", "appFeedback": "App Feedback", "yourRating": "Your Rating", "comments": "Comments",
                    "submitFeedback": "Submit Feedback", "logout": "Logout", "editYourProfile": "Edit Your Profile", "saveChanges": "Save Changes",
                    "feedbackThanks": "Thank you for your feedback!",
                    "addStaffMember": "Add Staff Member", "addStaff": "Add Staff", "staffRole": "Staff Role",
                    "otherMaterial": "Other Material", "materialName": "Material Name", "weightKg": "Weight (kg)",
                },
                hi: {
                    "welcome": "स्वागत है", "welcomeUser": "स्वागत है, {{name}}!", "home": "होम", "pay": "भुगतान करें", "inbox": "इनबॉक्स",
                    "book": "बुक करें", "history": "इतिहास", "profile": "प्रोफ़ाइल", "track": "ट्रैक करें", "sell": "बेचें", "dashboardTitle": "स्वागत है, {{name}}!",
                    "balance": "शेष राशि", "pendingBalance": "बकाया शेष।", "allSettled": "सब चुकता।", "cleared": "चुकता!",
                    "loginStreak": "लॉगिन स्ट्रीक", "daysInARow": "{{count}} दिन लगातार!", "daysInARow_plural": "{{count}} दिन लगातार!",
                    "reminder": "अनुस्मारक", "liveCollectionStatus": "लाइव संग्रह स्थिति", "viewOnMap": "मानचित्र पर देखें",
                    "noActiveVehicle": "आपके क्षेत्र में वर्तमान में कोई संग्रह वाहन सक्रिय नहीं है।", "communityWasteDiversion": "सामुदायिक अपशिष्ट डायवर्जन",
                    "total": "कुल", "recycled": "पुनर्नवीनीकरण", "composted": "खाद बनाया गया", "landfill": "लैंडफिल", "co2Saved": "कुल CO₂ बचाया गया: {{amount}} टन",
                    "chooseLogin": "अपना लॉगिन चुनें", "householdLogin": "परिवार लॉगिन", "staffLogin": "कर्मचारी लॉगिन", "adminLogin": "एडमिन लॉगिन",
                    "welcomeBack": "वापसी पर स्वागत है!", "mobileNumber": "मोबाइल नंबर", "emailAddress": "ईमेल पता", "password": "पासवर्ड",
                    "rememberMe": "मुझे याद रखें", "login": "लॉगिन", "forgotPassword": "पासवर्ड भूल गए? कृपया सहायता के लिए प्रशासक से संपर्क करें।",
                    "createAccount": "खाता बनाएं", "fullName": "पूरा नाम", "confirmPassword": "पासवर्ड की पुष्टि करें", "next": "अगला",
                    "yourDetails": "आपका विवरण", "familyMembers": "परिवार के सदस्यों की संख्या", "area": "क्षेत्र / मोहल्ला", "landmark": "निकटतम लैंडমার্ক",
                    "pincode": "क्षेत्र पिनकोड", "completeSignup": "साइन अप पूरा करें", "back": "वापस", "verification": "सत्यापन",
                    "adminVerification": "प्रशासक का मोबाइल नंबर दर्ज करें।", "sendOtp": "ओटीपी भेजें", "verifyOtp": "ओटीपी सत्यापित करें",
                    "otpSentTo": "{{identifier}} के लिए ओटीपी भेजा गया।", "change": "बदलें", "otpPlaceholder": "6-अंकीय ओटीपी",
                    "verifyAndProceed": "सत्यापित करें और आगे बढ़ें", "resendOtp": "ओटीपी फिर से भेजें", "resendOtpIn": "{{count}}s में फिर से भेजें",
                    "staffVerification": "अपना पंजीकृत मोबाइल नंबर दर्ज करें।", "yourRole": "आपकी भूमिका", "role_captain": "कप्तान",
                    "role_employee": "कर्मचारी", "role_sanitaryworker": "सफाई कर्मचारी", "staffNotice": "कर्मचारी सूचना",
                    "aMessageForYou": "आपके लिए एक संदेश", "sendNoticeToStaff": "सभी कर्मचारियों को एक सूचना भेजें",
                    "staffNoticeDescription": "यह संदेश लॉग इन करने पर सभी कर्मचारियों को एक पॉप-अप के रूप में दिखाया जाएगा।",
                    "updateNotice": "सूचना अपडेट करें", "noticeUpdated": "सूचना अपडेट हो गई!", "securityAlert": "सुरक्षा चेतावनी",
                    "weakPasswordWarning": "आपका वर्तमान पासवर्ड कमजोर है। अपनी सुरक्षा के लिए, कृपया एक नया, मजबूत पासवर्ड बनाएं।",
                    "changePassword": "पासवर्ड बदलें", "currentPassword": "वर्तमान पासवर्ड", "newPassword": "नया पासवर्ड",
                    "confirmNewPassword": "नए पासवर्ड की पुष्टि करें", "passwordChangedSuccess": "पासवर्ड सफलतापूर्वक बदल गया!",
                    "passwordMismatchError": "नए पासवर्ड मेल नहीं खाते।", "incorrectCurrentPasswordError": "गलत वर्तमान पासवर्ड।",
                    "pw8Chars": "8+ अक्षर", "pwUppercase": "बड़ा अक्षर", "pwLowercase": "छोटा अक्षर", "pwNumber": "संख्या",
                    "pwSpecial": "विशेष अक्षर", "mySellRequests": "मेरे बेचने के अनुरोध", "noSellRequests": "आपने अभी तक सामग्री बेचने का कोई अनुरोध नहीं किया है।",
                    "chatWithAdmin": "एडमिन के साथ चैट करें", "complaints": "शिकायतें", "submitComplaint": "शिकायत दर्ज करें", "issueType": "समस्या का प्रकार",
                    "details": "विवरण", "submit": "जमा करें", "myComplaints": "मेरी शिकायतें", "noComplaints": "आपने अभी तक कोई शिकायत दर्ज नहीं की है।",
                    "bookECart": "ई-कार्ट बुक करें", "bookECartDesc": "थोक या ई-कचरे जैसे विशेष कचरा संग्रह के लिए।", "wasteType": "कचरे का प्रकार",
                    "date": "तारीख", "timeSlot": "समय स्लॉट", "notes": "अतिरिक्त नोट्स (वैकल्पिक)", "bookNow": "अभी बुक करें", "myBookings": "मेरी बुकिंग",
                    "noBookings": "आपने अभी तक कोई बुकिंग नहीं की है।", "personalDetails": "व्यक्तिगत विवरण", "editProfile": "प्रोफ़ाइल संपादित करें",
                    "faq": "अक्सर पूछे जाने वाले प्रश्न", "appFeedback": "ऐप फीडबैक", "yourRating": "आपकी रेटिंग", "comments": "टिप्पणियाँ",
                    "submitFeedback": "फीडबैक जमा करें", "logout": "लॉगआउट", "editYourProfile": "अपनी प्रोफ़ाइल संपादित करें", "saveChanges": "बदलाव सहेजें",
                    "feedbackThanks": "आपके फीडबैक के लिए धन्यवाद!",
                    "addStaffMember": "कर्मचारी सदस्य जोड़ें", "addStaff": "कर्मचारी जोड़ें", "staffRole": "कर्मचारी की भूमिका",
                    "otherMaterial": "अन्य सामग्री", "materialName": "सामग्री का नाम", "weightKg": "वजन (किलो)",
                },
                bn: {
                    "welcome": "স্বাগতম", "welcomeUser": "স্বাগতম, {{name}}!", "home": "হোম", "pay": "পে করুন", "inbox": "ইনবক্স",
                    "book": "বুক করুন", "history": "ইতিহাস", "profile": "প্রোফাইল", "track": "ট্র্যাক", "sell": "বিক্রি", "dashboardTitle": "স্বাগতম, {{name}}!",
                    "balance": "ব্যালেন্স", "pendingBalance": "পেন্ডিং ব্যালেন্স।", "allSettled": "সব মেটানো।", "cleared": "পরিশোধিত!",
                    "loginStreak": "লগইন স্ট্রিক", "daysInARow": "টানা {{count}} দিন!", "daysInARow_plural": "টানা {{count}} দিন!",
                    "reminder": "অনুস্মারক", "liveCollectionStatus": "লাইভ সংগ্রহের স্থিতি", "viewOnMap": "মানচিত্রে দেখুন",
                    "noActiveVehicle": "আপনার এলাকায় বর্তমানে কোনো সংগ্রহ যানবাহন সক্রিয় নেই।", "communityWasteDiversion": "কমিউনিটি বর্জ্য ডাইভারশন",
                    "total": "মোট", "recycled": "পুনর্ব্যবহারযোগ্য", "composted": "কম্পোস্ট করা", "landfill": "ল্যান্ডফিল", "co2Saved": "মোট CO₂ সংরক্ষিত: {{amount}} টন",
                    "chooseLogin": "আপনার লগইন চয়ন করুন", "householdLogin": "পরিবার লগইন", "staffLogin": "স্টাফ লগইন", "adminLogin": "অ্যাডমিন লগইন",
                    "welcomeBack": "আবারও স্বাগতম!", "mobileNumber": "মোবাইল নম্বর", "emailAddress": "ইমেল ঠিকানা", "password": "পাসওয়ার্ড",
                    "rememberMe": "আমাকে মনে রাখুন", "login": "লগইন", "forgotPassword": "পাসওয়ার্ড ভুলে গেছেন? সহায়তার জন্য প্রশাসকের সাথে যোগাযোগ করুন।",
                    "createAccount": "অ্যাকাউন্ট তৈরি করুন", "fullName": "পুরো নাম", "confirmPassword": "পাসওয়ার্ড নিশ্চিত করুন", "next": "পরবর্তী",
                    "yourDetails": "আপনার বিবরণ", "familyMembers": "পরিবারের সদস্য সংখ্যা", "area": "এলাকা / পাড়া", "landmark": "নিকটতম ল্যান্ডমার্ক",
                    "pincode": "এলাকার পিনকোড", "completeSignup": "সাইন আপ সম্পূর্ণ করুন", "back": "ফিরে যান", "verification": "যাচাইকরণ",
                    "adminVerification": "প্রশাসকের মোবাইল নম্বর লিখুন।", "sendOtp": "OTP পাঠান", "verifyOtp": "OTP যাচাই করুন",
                    "otpSentTo": "{{identifier}} এর জন্য OTP পাঠানো হয়েছে।", "change": "পরিবর্তন", "otpPlaceholder": "৬-সংখ্যার OTP",
                    "verifyAndProceed": "যাচাই করে এগিয়ে যান", "resendOtp": "OTP আবার পাঠান", "resendOtpIn": "{{count}}s পরে আবার পাঠান",
                    "staffVerification": "আপনার নিবন্ধিত মোবাইল নম্বর লিখুন।", "yourRole": "আপনার ভূমিকা", "role_captain": "ক্যাপ্টেন",
                    "role_employee": "কর্মচারী", "role_sanitaryworker": "স্যানিটারি কর্মী", "staffNotice": "স্টাফ নোটিশ",
                    "aMessageForYou": "আপনার জন্য একটি বার্তা", "sendNoticeToStaff": "সমস্ত স্টাফকে একটি নোটিশ পাঠান",
                    "staffNoticeDescription": "এই বার্তাটি লগ ইন করার সময় সমস্ত স্টাফ সদস্যদের কাছে একটি পপ-আপ হিসাবে দেখানো হবে।",
                    "updateNotice": "নোটিশ আপডেট করুন", "noticeUpdated": "নোটিশ আপডেট করা হয়েছে!", "securityAlert": "নিরাপত্তা সতর্কতা",
                    "weakPasswordWarning": "আপনার বর্তমান পাসওয়ার্ড দুর্বল। আপনার সুরক্ষার জন্য, অনুগ্রহ করে একটি নতুন, শক্তিশালী পাসওয়ার্ড তৈরি করুন।",
                    "changePassword": "পাসওয়ার্ড পরিবর্তন করুন", "currentPassword": "বর্তমান পাসওয়ার্ড", "newPassword": "নতুন পাসওয়ার্ড",
                    "confirmNewPassword": "নতুন পাসওয়ার্ড নিশ্চিত করুন", "passwordChangedSuccess": "পাসওয়ার্ড সফলভাবে পরিবর্তিত হয়েছে!",
                    "passwordMismatchError": "নতুন পাসওয়ার্ড মিলছে না।", "incorrectCurrentPasswordError": "ভুল বর্তমান পাসওয়ার্ড।",
                    "pw8Chars": "৮+ অক্ষর", "pwUppercase": "বড় হাতের অক্ষর", "pwLowercase": "ছোট হাতের অক্ষর", "pwNumber": "সংখ্যা",
                    "pwSpecial": "বিশেষ অক্ষর", "mySellRequests": "আমার বিক্রয়ের অনুরোধ", "noSellRequests": "আপনি এখনও কোনো সামগ্রী বিক্রির অনুরোধ করেননি।",
                    "chatWithAdmin": "অ্যাডমিনের সাথে চ্যাট করুন", "complaints": "অভিযোগ", "submitComplaint": "একটি অভিযোগ জমা দিন", "issueType": "সমস্যার প্রকার",
                    "details": "বিস্তারিত", "submit": "জমা দিন", "myComplaints": "আমার অভিযোগ", "noComplaints": "আপনি এখনও কোনো অভিযোগ দায়ের করেননি।",
                    "bookECart": "একটি ই-কার্ট বুক করুন", "bookECartDesc": "বিশেষ বর্জ্য সংগ্রহ যেমন বাল্ক বা ই-বর্জ্যের জন্য।", "wasteType": "বর্জ্যের প্রকার",
                    "date": "তারিখ", "timeSlot": "সময় স্লট", "notes": "অতিরিক্ত নোট (ঐচ্ছিক)", "bookNow": "এখনই বুক করুন", "myBookings": "আমার বুকিং",
                    "noBookings": "আপনি এখনও কোনো বুকিং করেননি।", "personalDetails": "ব্যক্তিগত বিবরণ", "editProfile": "প্রোফাইল সম্পাদনা করুন",
                    "faq": "সচরাচর জিজ্ঞাস্য", "appFeedback": "অ্যাপ ফিডব্যাক", "yourRating": "আপনার রেটিং", "comments": "মন্তব্য",
                    "submitFeedback": "ফিডব্যাক জমা দিন", "logout": "লগআউট", "editYourProfile": "আপনার প্রোফাইল সম্পাদনা করুন", "saveChanges": "পরিবর্তনগুলি সংরক্ষণ করুন",
                    "feedbackThanks": "আপনার প্রতিক্রিয়ার জন্য ধন্যবাদ!",
                    "addStaffMember": "কর্মী সদস্য যোগ করুন", "addStaff": "কর্মী যোগ করুন", "staffRole": "কর্মীর ভূমিকা",
                    "otherMaterial": "অন্যান্য উপাদান", "materialName": "উপাদানের নাম", "weightKg": "ওজন (কেজি)",
                }
            };

            // =================================================================
            // 3. GLOBAL STATE MANAGEMENT
            // =================================================================
            const AppState = {
                // Core Data
                users: [], payments: [], complaints: [], bookings: [], messages: [], wasteLogs: [],
                sellRequests: [], sellRequestMessages: [], broadcastMessage: null, staffBroadcastMessage: null,
                subscriptionPlans: { standard: 63, largeFamily: 75, largeFamilyThreshold: 5 },

                // UI & Auth State
                loggedInUserId: null,
                forcePasswordChange: false,
                currentView: ViewType.Dashboard,
                currentAdminView: AdminView.Users,
                currentStaffView: StaffView.Dashboard,
                loginMode: 'selector', // 'selector' | 'user' | 'admin' | 'staff'
                theme: 'light',
                language: 'en',
                isModalOpen: false,
                
                authFlowState: {
                    isSignup: false, step: 1, formData: {}, error: null, otpSent: false,
                    otpIdentifier: '', resendTimer: 0, passwordStrength: 0, otp: null,
                },
                
                // Helper to get current user
                currentUser() {
                    return this.users.find(u => u.householdId === this.loggedInUserId) || null;
                },

                // --- Persistence ---
                dateReviver(key, value) {
                    if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/.test(value)) {
                        return new Date(value);
                    }
                    return value;
                },
                loadFromStorage(key, initialValue) {
                    try {
                        const item = window.localStorage.getItem(`ecotrack_${key}`);
                        if (item) return JSON.parse(item, this.dateReviver);
                    } catch (error) { console.error(`Error loading ${key} from storage.`, error); }
                    return initialValue;
                },
                saveToStorage(key, value) {
                    try {
                        window.localStorage.setItem(`ecotrack_${key}`, JSON.stringify(value));
                    } catch (error) { console.error(`Error saving ${key} to storage.`, error); }
                },

                // --- Initial Data (Mocks) ---
                getInitialData() {
                    const initialUsers = [
                        { name: 'SHYANTAN BISWAS', householdId: 'ADM-SHYA-9052', identifier: '9635929052', password: 'Password@123', role: 'admin', status: 'active', hasGreenBadge: true, bookingReminders: true, profilePicture: '', email: 'shyantanbiswas7@gmail.com', createdAt: new Date(2024, 5, 1), outstandingBalance: 75, familySize: 4, address: { area: 'Main Street', landmark: 'City Hall', pincode: '700001' }, gramPanchayat: 'KAJORA' },
                        { name: 'PROSENJIT MAJI', householdId: 'ADM-PROS-3897', identifier: '8016233897', password: 'Password@123', role: 'admin', status: 'active', hasGreenBadge: true, bookingReminders: true, profilePicture: '', email: 'prosenjit.maji@andalg2g.com', createdAt: new Date(2024, 5, 1), outstandingBalance: 0, familySize: 1, address: { area: 'Admin Area', landmark: 'Admin Building', pincode: '000000' }, gramPanchayat: 'ANDAL' },
                        { name: 'Surya Laha', householdId: 'ADM-SURY-1746', identifier: '9064201746', password: 'Password@123', role: 'admin', status: 'active', hasGreenBadge: true, bookingReminders: true, profilePicture: '', email: 'ecotrack@andalgraytogreen.in', createdAt: new Date(2024, 5, 1), outstandingBalance: 0, familySize: 1, address: { area: 'Admin Area', landmark: 'Admin Building', pincode: '000000' }, gramPanchayat: 'ANDAL' },
                        { name: 'Jane Doe', householdId: 'HH-JANE-9876', identifier: '9876543210', password: 'password', role: 'household', status: 'active', hasGreenBadge: false, bookingReminders: true, profilePicture: '', email: 'jane.doe@example.com', createdAt: new Date(2024, 6, 10), outstandingBalance: 150, familySize: 6, address: { area: 'Willow Creek', landmark: 'Near Park', pincode: '123456' }, gramPanchayat: 'UKHRA', consecutiveMixedLogs: 1, pushNotificationsEnabled: true },
                        { name: 'Ravi Kumar', householdId: 'EMP-RAVI-1234', identifier: '8888888888', password: 'Password@123', role: 'employee', status: 'active', createdAt: new Date(2024, 5, 2), attendanceStatus: 'on_leave', familySize: 1, address: { area: 'Staff Quarters', landmark: 'Unit 5', pincode: '110022' }, outstandingBalance: 0, email: 'ravi.k@staff.com', gramPanchayat: 'KHANDRA', lastLocation: { lat: 23.681, lng: 87.215 } },
                        { name: 'Suresh Singh', householdId: 'CPT-SURE-5678', identifier: '9999999999', password: 'Password@123', role: 'captain', status: 'active', createdAt: new Date(2024, 5, 3), attendanceStatus: 'on_leave', familySize: 1, address: { area: 'Staff Quarters', landmark: 'Unit 8', pincode: '110022' }, outstandingBalance: 0, email: 'suresh.s@staff.com', gramPanchayat: 'DAKSHINKHANDA', profilePicture: 'https://images.unsplash.com/photo-1599566150163-29194dcaad36?q=80&w=1887&auto=format&fit=crop', lastLocation: { lat: 23.685, lng: 87.220 } },
                        { name: 'Amit Das', householdId: 'SNW-AMIT-4321', identifier: '6666666666', password: 'Password@123', role: 'sanitaryworker', status: 'active', createdAt: new Date(2024, 5, 4), attendanceStatus: 'present', familySize: 1, address: { area: 'Staff Quarters', landmark: 'Unit 9', pincode: '110022' }, outstandingBalance: 0, email: 'amit.d@staff.com', gramPanchayat: 'UKHRA', lastLocation: { lat: 23.689, lng: 87.225 }, lastLocationUpdate: new Date() },
                    ];
                    const initialPayments = [
                        { id: 'TXN789123', householdId: 'ADM-SHYA-9052', date: new Date(2024, 6, 15, 10, 30, 12), amount: 75, status: 'Paid' },
                        { id: 'TXN654321', householdId: 'ADM-SHYA-9052', date: new Date(2024, 5, 14, 9, 15, 45), amount: 75, status: 'Paid' },
                        { id: 'TXN112233', householdId: 'HH-JANE-9876', date: new Date(2024, 6, 14, 8, 0, 0), amount: 75, status: 'Paid' },
                        { id: 'TXN445566', householdId: 'HH-JANE-9876', date: new Date(), amount: 75, status: 'Pending Verification', screenshot: 'https://via.placeholder.com/300x600.png?text=Sample+Payment+Screenshot' },
                    ];
                    const initialComplaints = [
                        { id: 'CMPT-001', householdId: 'ADM-SHYA-9052', date: new Date(2024, 6, 10), issue: 'Missed Pickup', status: 'Resolved', details: 'Collector did not arrive on the scheduled day.' },
                        { id: 'CMPT-002', householdId: 'ADM-SHYA-9052', date: new Date(), issue: 'Driver Behavior', status: 'Pending', details: 'The driver was rude.' },
                        { id: 'CMPT-003', householdId: 'HH-JANE-9876', date: new Date(2024, 6, 20), issue: 'Payment Issue', status: 'In Progress', details: 'My payment is not reflecting in the app.' },
                    ];
                    const initialBookings = [
                        { id: 'BK-001', householdId: 'ADM-SHYA-9052', date: '2024-07-28', timeSlot: 'Morning', wasteType: 'Garden Waste', status: 'Completed' },
                        { id: 'BK-002', householdId: 'HH-JANE-9876', date: '2024-08-05', timeSlot: 'Afternoon', wasteType: 'E-Waste', status: 'Scheduled', attendeeCount: 250, bookingFee: 0 },
                        { id: 'BK-003', householdId: 'ADM-SHYA-9052', date: '2024-08-10', timeSlot: 'Morning', wasteType: 'Bulk Waste', status: 'Pending Approval', notes: 'Old mattress and sofa' },
                    ];
                    const initialMessages = [
                        { id: 'MSG-001', recipientId: 'HH-JANE-9876', text: 'Hi Jane, please ensure your waste is properly segregated for the next pickup. Thank you!', timestamp: new Date(2024, 6, 22, 11, 45), read: false },
                        { id: 'MSG-002', recipientId: 'ADM-SHYA-9052', text: 'Your "Driver Behavior" complaint (CMPT-002) has been reviewed. We have taken action and apologize for the inconvenience.', timestamp: new Date(), read: true },
                    ];
                     const initialWasteLogs = [
                        { householdId: 'HH-JANE-9876', type: 'Mixed Waste', date: new Date(new Date().setDate(new Date().getDate() - 1)) }
                    ];
                    const initialSellRequests = [
                        { id: 'SELL-001', householdId: 'ADM-SHYA-9052', date: new Date(2024, 6, 25), materials: { plastic: 5, paper: 2 }, weightKg: 7, status: 'Approved', estimatedCost: 150 },
                        { id: 'SELL-002', householdId: 'HH-JANE-9876', date: new Date(), materials: { glass: 10, steel: 3 }, weightKg: 13, status: 'Pending', estimatedCost: 0 }
                    ];
                    const initialSellRequestMessages = [
                        { id: 'SRM-001', sellRequestId: 'SELL-001', sender: 'admin', text: 'Hi, I have approved your request. The estimated value is Rs. 150. When is a good time for us to come by and pick up the materials?', timestamp: new Date() },
                        { id: 'SRM-002', sellRequestId: 'SELL-001', sender: 'user', text: 'That sounds great! Tomorrow afternoon works for me.', timestamp: new Date() }
                    ];

                    this.users = this.loadFromStorage('users', initialUsers);
                    this.payments = this.loadFromStorage('payments', initialPayments);
                    this.complaints = this.loadFromStorage('complaints', initialComplaints);
                    this.bookings = this.loadFromStorage('bookings', initialBookings);
                    this.messages = this.loadFromStorage('messages', initialMessages);
                    this.wasteLogs = this.loadFromStorage('wasteLogs', initialWasteLogs);
                    this.sellRequests = this.loadFromStorage('sellRequests', initialSellRequests);
                    this.sellRequestMessages = this.loadFromStorage('sellRequestMessages', initialSellRequestMessages);
                    this.broadcastMessage = this.loadFromStorage('broadcastMessage', "Eco Track: A friendly reminder that monthly payments are due by the end of the week. Thank you!");
                    this.staffBroadcastMessage = this.loadFromStorage('staffBroadcastMessage', "Believe you can and you're halfway there. - Theodore Roosevelt");
                    this.subscriptionPlans = this.loadFromStorage('subscriptionPlans', { standard: 63, largeFamily: 75, largeFamilyThreshold: 5 });
                },

                // --- Init & State Sync ---
                init() {
                    this.getInitialData();
                    const savedTheme = localStorage.getItem('theme') || 'dark';
                    this.setTheme(savedTheme);
                    this.setLanguage(localStorage.getItem('language') || 'en');
                    const savedUserId = localStorage.getItem('ecotrack-user-id') || sessionStorage.getItem('ecotrack-user-id');
                    if (savedUserId) {
                        const potentialUser = this.users.find(u => u.householdId === savedUserId);
                        if (potentialUser) {
                            this.loggedInUserId = savedUserId;
                            if (potentialUser.password && !this.isStrongPassword(potentialUser.password)) this.forcePasswordChange = true;
                            if (potentialUser.role === 'admin' && !localStorage.getItem('isAdminMode')) {
                                this.logout();
                            }
                        }
                    }
                },
                
                // --- Auth Methods ---
                isStrongPassword(password) {
                    if (!password) return false;
                    const minLength = 8, hasUpperCase = /[A-Z]/.test(password), hasLowerCase = /[a-z]/.test(password);
                    const hasNumbers = /\d/.test(password), hasNonalphas = /\W|_/.test(password);
                    return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers && hasNonalphas;
                },
                 calculatePasswordStrength(password) {
                    if (!password) return 0;
                    let score = 0;
                    if (password.length >= 8) score++;
                    if (/[A-Z]/.test(password)) score++;
                    if (/[a-z]/.test(password)) score++;
                    if (/\d/.test(password)) score++;
                    if (/\W|_/.test(password)) score++;
                    return score;
                },
                handleStreakLogic(user) {
                    const today = new Date(); today.setHours(0, 0, 0, 0);
                    const lastIncrement = user.lastStreakIncrement ? new Date(user.lastStreakIncrement) : null;
                    if (lastIncrement) lastIncrement.setHours(0, 0, 0, 0);
                    if (!lastIncrement || lastIncrement.getTime() !== today.getTime()) {
                        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                        return { loginStreak: (lastIncrement && lastIncrement.getTime() === yesterday.getTime()) ? (user.loginStreak || 0) + 1 : 1, lastStreakIncrement: new Date() };
                    }
                    return {};
                },
                login(identifier, password, rememberMe) {
                    const existingUser = this.users.find(u => u.identifier === identifier.replace(/[^0-9]/g, ''));
                    if (!existingUser) return { success: false, message: 'No account found with this mobile number.' };
                    if (existingUser.role !== 'household') return { success: false, message: 'Access denied for this portal.'};
                    if (existingUser.status === 'blocked') return { success: false, message: 'Your account has been blocked. Please contact support.' };
                    if (existingUser.password !== password) return { success: false, message: 'Invalid password.' };

                    this.forcePasswordChange = existingUser.password && !this.isStrongPassword(existingUser.password);
                    const streakUpdates = this.handleStreakLogic(existingUser);
                    const updatedUser = { ...existingUser, lastLoginTime: new Date(), lastIpAddress: `103.12.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`, ...streakUpdates };
                    this.updateUser(updatedUser);
                    
                    const storage = rememberMe ? localStorage : sessionStorage;
                    storage.setItem('ecotrack-user-id', existingUser.householdId);
                    this.loggedInUserId = existingUser.householdId;
                    return { success: true, user: updatedUser };
                },
                signup(params) {
                    const { name, identifier, email, password, familySize, address, gramPanchayat } = params;
                    if (this.users.some(u => u.identifier === identifier)) return { success: false, message: 'An account with this mobile number already exists.' };
                    if (this.users.some(u => u.email.toLowerCase() === email.toLowerCase())) return { success: false, message: 'An account with this email address already exists.' };
                    if (!password || !this.isStrongPassword(password)) return { success: false, message: 'Password is not strong enough.' };
                    
                    const householdId = `HH-${identifier.slice(0, 4).toUpperCase()}-${Date.now().toString().slice(-4)}`;
                    const balance = familySize > this.subscriptionPlans.largeFamilyThreshold ? this.subscriptionPlans.largeFamily : this.subscriptionPlans.standard;
                    const newUser = { name, householdId, identifier, password, role: 'household', status: 'active', hasGreenBadge: false,
                        bookingReminders: true, pushNotificationsEnabled: true, profilePicture: '', email, createdAt: new Date(),
                        outstandingBalance: balance, familySize, address, gramPanchayat, loginStreak: 1, lastStreakIncrement: new Date(), consecutiveMixedLogs: 0 };
                    this.addUser(newUser);
                    sessionStorage.setItem('ecotrack-user-id', householdId);
                    this.loggedInUserId = householdId;
                    this.forcePasswordChange = false;
                    return { success: true, user: newUser };
                },
                sendAdminOtp(identifier) {
                    const adminIdentifiers = ['9635929052', '8016233897', '9064201746'];
                    if (!adminIdentifiers.includes(identifier)) {
                        return { success: false, message: 'This mobile number is not registered for admin access.' };
                    }
                    const otp = String(Math.floor(100000 + Math.random() * 900000));
                    this.authFlowState.otp = otp;
                    this.authFlowState.otpIdentifier = identifier;
                    this.authFlowState.otpSent = true;
                    this.authFlowState.error = null;
                    
                    this.startResendTimer();
                    return { success: true, otp };
                },
                verifyAdminOtpAndLogin(otp) {
                    if (otp !== this.authFlowState.otp) {
                        return { success: false, message: 'Invalid OTP. Please try again.' };
                    }
                    const adminUser = this.users.find(u => u.identifier === this.authFlowState.otpIdentifier && u.role === 'admin');
                    if (!adminUser) { // Should not happen if sendAdminOtp check passes
                        return { success: false, message: 'Admin account not found.' };
                    }

                    localStorage.setItem('ecotrack-user-id', adminUser.householdId);
                    localStorage.setItem('isAdminMode', 'true');
                    this.loggedInUserId = adminUser.householdId;
                    this.forcePasswordChange = false;
                    
                    // Reset auth state
                    this.authFlowState.otp = null;
                    this.authFlowState.otpSent = false;
                    this.authFlowState.otpIdentifier = '';
                    clearInterval(resendInterval);
                    
                    return { success: true };
                },
                startResendTimer() {
                    this.authFlowState.resendTimer = 30;
                    clearInterval(resendInterval);
                    resendInterval = setInterval(() => {
                        this.authFlowState.resendTimer--;
                        if (this.authFlowState.resendTimer <= 0) {
                            clearInterval(resendInterval);
                        }
                        const timerEl = document.getElementById('resend-timer');
                        if (timerEl) {
                            timerEl.textContent = this.t('resendOtpIn', { count: this.authFlowState.resendTimer });
                        } else if (this.authFlowState.resendTimer <= 0) {
                            const resendBtn = document.getElementById('resend-btn');
                            if(resendBtn) resendBtn.disabled = false;
                        }
                    }, 1000);
                },
                loginAsStaff(identifier) {
                    const staffRoles = ['employee', 'captain', 'sanitaryworker'];
                    const userToLogin = this.users.find(u => u.identifier === identifier);
                    if (!userToLogin) return { success: false, message: 'No account found with this number.' };
                    const isAdminOverride = userToLogin.role === 'admin' && userToLogin.identifier === '9635929052';
                    if (!staffRoles.includes(userToLogin.role) && !isAdminOverride) return { success: false, message: 'This account does not have staff permissions.' };
                    if (userToLogin.status === 'blocked') return { success: false, message: 'Your account has been blocked.' };
                    
                    this.forcePasswordChange = userToLogin.password && !this.isStrongPassword(userToLogin.password);
                    const now = new Date();
                    const tenAM = new Date(); tenAM.setHours(10, 0, 0, 0);
                    const tenThirtyAM = new Date(); tenThirtyAM.setHours(10, 30, 0, 0);
                    const attendanceStatus = (now >= tenAM && now <= tenThirtyAM) ? 'present' : 'absent';
                    
                    const streakUpdates = this.handleStreakLogic(userToLogin);
                    const updatedUser = { ...userToLogin, attendanceStatus, lastLoginTime: now, lastIpAddress: `103.12.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`, ...streakUpdates };
                    this.updateUser(updatedUser);
                    sessionStorage.setItem('ecotrack-user-id', updatedUser.householdId);
                    this.loggedInUserId = updatedUser.householdId;
                    return { success: true, user: updatedUser };
                },
                logout() {
                    stopLocationTracking();
                    localStorage.removeItem('ecotrack-user-id');
                    sessionStorage.removeItem('ecotrack-user-id');
                    localStorage.removeItem('isAdminMode');
                    localStorage.removeItem('broadcast-seen');
                    sessionStorage.removeItem('staff-notice-seen');
                    this.loggedInUserId = null;
                    this.forcePasswordChange = false;
                    this.loginMode = 'selector';
                },
                changePassword(currentPassword, newPassword) {
                    const user = this.currentUser();
                    if (!user) return { success: false, message: "No user is logged in." };
                    if (user.password !== currentPassword) return { success: false, message: "Incorrect current password." };
                    if (!this.isStrongPassword(newPassword)) return { success: false, message: "The new password is not strong enough." };
                    
                    this.updateUser({ ...user, password: newPassword });
                    this.forcePasswordChange = false;
                    return { success: true };
                },

                // --- Data Mutation Methods ---
                addUser(user) { this.users = [...this.users, user]; this.saveToStorage('users', this.users); },
                updateUser(updatedUser) { this.users = this.users.map(u => u.householdId === updatedUser.householdId ? updatedUser : u); this.saveToStorage('users', this.users); },
                deleteUser(householdId) { this.users = this.users.filter(u => u.householdId !== householdId); this.saveToStorage('users', this.users); },
                addPayment(payment) { this.payments = [payment, ...this.payments]; this.saveToStorage('payments', this.payments); },
                updatePayment(updatedPayment) { this.payments = this.payments.map(p => p.id === updatedPayment.id ? updatedPayment : p); this.saveToStorage('payments', this.payments); },
                addComplaint(complaint) { this.complaints = [complaint, ...this.complaints]; this.saveToStorage('complaints', this.complaints); },
                updateComplaint(updatedComplaint) { this.complaints = this.complaints.map(c => c.id === updatedComplaint.id ? updatedComplaint : c); this.saveToStorage('complaints', this.complaints); },
                addBooking(booking) { if(booking.bookingFee) this.updateUser({...this.currentUser(), outstandingBalance: this.currentUser().outstandingBalance + booking.bookingFee}); this.bookings = [booking, ...this.bookings]; this.saveToStorage('bookings', this.bookings); },
                updateBooking(updatedBooking) { this.bookings = this.bookings.map(b => b.id === updatedBooking.id ? updatedBooking : b); this.saveToStorage('bookings', this.bookings); },
                addMessage(recipientId, text) { const msg = { id: `MSG-${Date.now()}`, recipientId, text, timestamp: new Date(), read: false }; this.messages = [msg, ...this.messages]; this.saveToStorage('messages', this.messages); },
                markMessagesAsRead(householdId) { let changed = false; this.messages = this.messages.map(m => { if(m.recipientId === householdId && !m.read){ changed = true; return {...m, read: true}; } return m; }); if(changed) this.saveToStorage('messages', this.messages); },
                addWasteLog(log) { this.wasteLogs = [...this.wasteLogs, log]; this.saveToStorage('wasteLogs', this.wasteLogs); },
                addSellRequest(request) { this.sellRequests = [request, ...this.sellRequests]; this.saveToStorage('sellRequests', this.sellRequests); },
                updateSellRequest(request) { this.sellRequests = this.sellRequests.map(r => r.id === request.id ? request : r); this.saveToStorage('sellRequests', this.sellRequests); },
                addSellRequestMessage(message) { const newMessage = { ...message, id: `SRM-${Date.now()}`, timestamp: new Date() }; this.sellRequestMessages = [...this.sellRequestMessages, newMessage]; this.saveToStorage('sellRequestMessages', this.sellRequestMessages); },
                updateUserLocation(householdId, location) { const user = this.users.find(u => u.householdId === householdId); if(user) this.updateUser({...user, lastLocation: location, lastLocationUpdate: new Date() }); },
                updateBroadcastMessage(msg) { this.broadcastMessage = msg; this.saveToStorage('broadcastMessage', this.broadcastMessage); },
                updateStaffBroadcastMessage(msg) { this.staffBroadcastMessage = msg; this.saveToStorage('staffBroadcastMessage', this.staffBroadcastMessage); },
                
                // --- UI State Methods ---
                setTheme(theme) {
                    this.theme = theme;
                    document.documentElement.classList.remove('light', 'dark');
                    document.documentElement.classList.add(theme);
                    localStorage.setItem('theme', theme);
                },
                toggleTheme() { this.setTheme(this.theme === 'light' ? 'dark' : 'light'); render(); },
                setLanguage(lang) {
                    this.language = lang;
                    localStorage.setItem('language', lang);
                },
                t(key, options) {
                    let translation = translations[this.language]?.[key] || translations['en']?.[key] || key;
                    if (options) {
                        Object.keys(options).forEach(optKey => {
                            translation = translation.replace(new RegExp(`{{${optKey}}}`, 'g'), String(options[optKey]));
                        });
                    }
                    if (options && typeof options.count === 'number' && options.count !== 1) {
                        const pluralKey = `${key}_plural`;
                        const pluralTranslation = translations[this.language]?.[pluralKey] || translations['en']?.[pluralKey];
                        if (pluralTranslation) {
                           translation = pluralTranslation.replace(/{{count}}/g, String(options.count));
                        }
                    }
                    return translation;
                }
            };

            // =================================================================
            // 4. GEMINI API SERVICE
            // =================================================================
            const GeminiService = {
                ai: null,
                init() {
                    const API_KEY = ""; // Replace with your actual API key for local testing, but it should be handled by env vars in production
                    if (API_KEY) {
                        try {
                            this.ai = new GoogleGenAI({ apiKey: API_KEY });
                        } catch (e) {
                            console.error("Failed to initialize GoogleGenAI:", e);
                            this.ai = null;
                        }
                    } else {
                        console.warn("Gemini API key not found. AI features will be disabled.");
                    }
                },
                async getChatbotResponse(prompt) {
                    if (!this.ai) return "AI Chatbot is currently unavailable. Please check the API key configuration.";
                    const model = 'gemini-2.5-flash';
                    const systemInstruction = `You are EcoHelper, a friendly and knowledgeable AI assistant for the Eco Track Solid Waste Management app. Your purpose is to help users with their questions about waste management. Provide clear, concise information on waste segregation, composting, and recycling. Keep answers brief, positive, and easy to understand. If asked about topics outside of waste management, politely decline.`;
                    try {
                        const response = await this.ai.models.generateContent({ model, contents: prompt, config: { systemInstruction } });
                        return response.text;
                    } catch (error) {
                        console.error("Gemini API Error:", error);
                        return "Sorry, I'm having trouble connecting to the AI service right now.";
                    }
                }
            };
            
            // =================================================================
            // 5. UTILITY FUNCTIONS
            // =================================================================
            const getUserInitials = (name) => {
                const parts = (name || '').split(' ');
                return parts.length > 1 ? `${parts[0][0]}${parts[parts.length - 1][0]}`.toUpperCase() : (name || '??').substring(0, 2).toUpperCase();
            };
            const escapeHTML = (str) => String(str).replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
            const formatDateTime = (date) => {
                if (!date) return 'N/A';
                return new Date(date).toLocaleString(undefined, {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            };


            // =================================================================
            // 6. RENDERER FUNCTIONS (HTML TEMPLATES)
            // =================================================================
            
            function renderHeader(user) {
                const t = AppState.t.bind(AppState);
                const unreadMessages = AppState.messages.filter(m => m.recipientId === user.householdId && !m.read).length;
                return `
                <header class="bg-gradient-to-r from-primary to-accent text-white p-4 shadow-lg w-full max-w-lg mx-auto sticky top-0 z-20">
                  <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                       <div class="relative">
                            ${user.profilePicture ? 
                                `<img src="${user.profilePicture}" alt="Profile" class="h-10 w-10 rounded-full object-cover border-2 border-white/50">` : 
                                `<div class="h-10 w-10 rounded-full bg-primary-dark flex items-center justify-center font-bold text-white text-lg border-2 border-white/50">${getUserInitials(user.name)}</div>`
                            }
                       </div>
                       <div>
                        <h1 class="text-2xl font-bold" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.2)">Eco Track</h1>
                        <p class="text-xs opacity-80 -mt-1">powered by <span class="font-semibold bg-gradient-to-r from-yellow-300 via-amber-400 to-orange-500 text-transparent bg-clip-text bg-size-300 animate-gradient-pan">${NGO_NAME}</span></p>
                       </div>
                    </div>
                    <div class="flex items-center space-x-4">
                      <div class="relative">
                          <i data-lucide="globe" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-white/70 pointer-events-none" style="width: 16px; height: 16px;"></i>
                          <select id="language-switcher-header" class="bg-black/20 text-white text-sm font-semibold rounded-full appearance-none pl-8 pr-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-white/50" aria-label="Select language">
                            <option value="en" ${AppState.language === 'en' ? 'selected' : ''}>EN</option>
                            <option value="hi" ${AppState.language === 'hi' ? 'selected' : ''}>HI</option>
                            <option value="bn" ${AppState.language === 'bn' ? 'selected' : ''}>BN</option>
                          </select>
                      </div>
                      <button data-view="${ViewType.Messages}" class="relative p-2 rounded-full hover:bg-black/20 transition-colors" aria-label="View Messages">
                        <i data-lucide="inbox" style="width: 20px; height: 20px;"></i>
                        ${unreadMessages > 0 ? `<span class="absolute top-0 right-0 block h-4 w-4 rounded-full bg-red-500 text-white text-xs font-bold ring-2 ring-primary">${unreadMessages}</span>` : ''}
                      </button>
                      <div class="flex items-center">
                        <i data-lucide="sun" class="w-5 h-5 text-yellow-300"></i>
                        <button id="theme-toggle-btn" 
                                class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 mx-2
                                       bg-primary-dark/80 dark:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white/50 focus:ring-offset-primary" 
                                role="switch" 
                                aria-checked="${AppState.theme === 'dark'}">
                          <span class="sr-only">Toggle theme</span>
                          <span class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200 
                                       translate-x-0 dark:translate-x-5"></span>
                        </button>
                        <i data-lucide="moon" class="w-5 h-5 text-slate-300"></i>
                      </div>
                    </div>
                  </div>
                </header>`;
            }

            function renderBottomNav(currentView) {
                const t = AppState.t.bind(AppState);
                const navItems = [
                    { view: ViewType.Dashboard, icon: 'home', label: t('home') },
                    { view: ViewType.Booking, icon: 'calendar-plus', label: t('book') },
                    { view: ViewType.Sell, icon: 'shopping-cart', label: t('sell') },
                    { view: ViewType.History, icon: 'history', label: t('history') },
                    { view: ViewType.Profile, icon: 'user-circle', label: t('profile') },
                ];
                return `
                <nav class="fixed bottom-0 left-0 right-0 w-full max-w-lg mx-auto bg-card-light/80 dark:bg-card-dark/80 backdrop-blur-lg border-t border-border-light dark:border-border-dark h-16 flex justify-around items-center z-20 shadow-[0_-5px_15px_-5px_rgba(0,0,0,0.1)]">
                    ${navItems.map(item => `
                        <button data-view="${item.view}" class="flex flex-col items-center justify-center h-full w-full text-sm font-medium transition-colors ${currentView === item.view ? 'text-primary' : 'text-secondary-dark hover:text-primary'}">
                            <i data-lucide="${item.icon}" class="mb-1 ${currentView === item.view ? 'scale-110' : ''}"></i>
                            <span>${item.label}</span>
                        </button>
                    `).join('')}
                </nav>`;
            }

            function renderWasteLogger(user) {
                const todayStr = new Date().toISOString().split('T')[0];
                const hasLoggedToday = AppState.wasteLogs.some(log => 
                    log.householdId === user.householdId && 
                    new Date(log.date).toISOString().split('T')[0] === todayStr
                );

                if (hasLoggedToday) {
                    return `
                    <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-border-light dark:border-border-dark text-center">
                        <h3 class="font-semibold text-lg mb-2 flex items-center justify-center text-heading-light dark:text-heading-dark"><i data-lucide="check-check" class="mr-2 text-primary"></i>Log Your Waste</h3>
                        <p class="text-success font-semibold">Thanks! You've logged your waste for today.</p>
                    </div>`;
                }

                return `
                <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                    <h3 class="font-semibold text-lg mb-3 text-heading-light dark:text-heading-dark">Log Your Waste</h3>
                    <p class="text-sm text-text-light dark:text-text-dark mb-4">Log your daily waste type. A fine of ₹100 is applied after three consecutive "Mixed Waste" logs.</p>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <button data-action="log-waste" data-waste-type="Wet" class="p-3 bg-green-100 dark:bg-green-900/50 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/80 transition-colors">
                            <span class="text-3xl">🍎</span>
                            <span class="block text-sm font-semibold text-green-800 dark:text-green-200 mt-1">Wet Waste</span>
                        </button>
                        <button data-action="log-waste" data-waste-type="Dry" class="p-3 bg-blue-100 dark:bg-blue-900/50 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/80 transition-colors">
                            <span class="text-3xl">📦</span>
                            <span class="block text-sm font-semibold text-blue-800 dark:text-blue-200 mt-1">Dry Waste</span>
                        </button>
                        <button data-action="log-waste" data-waste-type="Mixed" class="p-3 bg-red-100 dark:bg-red-900/50 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/80 transition-colors">
                            <span class="text-3xl">🗑️</span>
                            <span class="block text-sm font-semibold text-red-800 dark:text-red-200 mt-1">Mixed Waste</span>
                        </button>
                    </div>
                    <p class="text-xs text-center text-secondary-dark mt-3">Consecutive 'Mixed Waste' logs: <span class="font-bold">${user.consecutiveMixedLogs || 0} / 3</span>.</p>
                </div>`;
            }

            function renderDashboard(user, bookings) {
                const t = AppState.t.bind(AppState);
                const upcomingBooking = bookings.find(b => new Date(b.date) > new Date() && b.status === 'Scheduled');
                
                return `
                <div class="space-y-6 animate-fade-in-up">
                  <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent animate-fade-in-down">${t('dashboardTitle', { name: user.name.split(' ')[0] })}</h2>
                  
                  <div class="grid grid-cols-2 gap-4">
                    <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md transition-all hover:shadow-lg hover:-translate-y-1 border border-border-light dark:border-border-dark" style="animation-delay: 100ms">
                      <h3 class="font-semibold text-lg mb-3 flex items-center text-heading-light dark:text-heading-dark"><i data-lucide="indian-rupee" class="mr-2 text-primary"></i>${t('balance')}</h3>
                      ${user.outstandingBalance > 0 ? `
                        <div>
                          <p class="text-sm text-text-light dark:text-text-dark">${t('pendingBalance')}</p>
                          <p class="text-3xl font-bold text-danger mt-2">₹${user.outstandingBalance.toFixed(2)}</p>
                        </div>
                      ` : `
                        <div>
                          <p class="text-sm text-text-light dark:text-text-dark">${t('allSettled')}</p>
                          <p class="text-3xl font-bold text-success mt-2 flex items-center"><i data-lucide="check-circle" class="mr-2"></i> ${t('cleared')}</p>
                        </div>
                      `}
                    </div>
                    <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md transition-all hover:shadow-lg hover:-translate-y-1 border border-border-light dark:border-border-dark" style="animation-delay: 150ms">
                      <h3 class="font-semibold text-lg mb-3 flex items-center text-heading-light dark:text-heading-dark"><i data-lucide="flame" class="mr-2 text-orange-500"></i>${t('loginStreak')}</h3>
                        <div class="text-center">
                            <p class="text-4xl font-bold text-orange-500 mt-2">${user.loginStreak || 0}</p>
                            <p class="text-sm text-text-light dark:text-text-dark">${t(user.loginStreak === 1 ? 'daysInARow' : 'daysInARow_plural', { count: user.loginStreak || 0 })}</p>
                        </div>
                    </div>
                  </div>

                  ${renderWasteLogger(user)}
                  
                  ${upcomingBooking ? `
                    <div class="bg-info/10 dark:bg-info/20 border-l-4 border-info text-info p-4 rounded-r-lg shadow-md" role="alert" style="animation-delay: 200ms">
                      <div class="flex items-center">
                        <i data-lucide="bell-ring" class="h-6 w-6 mr-3 flex-shrink-0"></i>
                        <div>
                          <p class="font-bold">${t('reminder')}</p>
                          <p class="text-sm">You have a ${upcomingBooking.wasteType} collection on ${upcomingBooking.date} (${upcomingBooking.timeSlot}).</p>
                        </div>
                      </div>
                    </div>
                  ` : ''}

                  <div class="grid grid-cols-2 gap-4">
                     <button data-view="${ViewType.Track}" class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md transition-all hover:shadow-lg hover:-translate-y-1 border border-border-light dark:border-border-dark text-left">
                        <h3 class="font-semibold text-lg mb-1 flex items-center text-heading-light dark:text-heading-dark"><i data-lucide="map-pin" class="mr-2 text-primary"></i>${t('track')}</h3>
                        <p class="text-sm text-text-light dark:text-text-dark">${t('liveCollectionStatus')}</p>
                     </button>
                      <button data-view="${ViewType.Payment}" class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md transition-all hover:shadow-lg hover:-translate-y-1 border border-border-light dark:border-border-dark text-left">
                        <h3 class="font-semibold text-lg mb-1 flex items-center text-heading-light dark:text-heading-dark"><i data-lucide="indian-rupee" class="mr-2 text-accent"></i>${t('pay')}</h3>
                        <p class="text-sm text-text-light dark:text-text-dark">Pay your monthly bill.</p>
                      </button>
                  </div>


                  <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md transition-all hover:shadow-lg hover:-translate-y-1 border border-border-light dark:border-border-dark" style="animation-delay: 400ms">
                    <h3 class="font-semibold text-lg mb-3 flex items-center text-heading-light dark:text-heading-dark"><i data-lucide="pie-chart" class="mr-2 text-primary"></i>${t('communityWasteDiversion')}</h3>
                    <div class="md:grid md:grid-cols-2 md:gap-4 items-center">
                        <div class="chart-container">
                            <canvas id="community-pie-chart"></canvas>
                        </div>
                        <div id="pie-chart-legend" class="mt-4 md:mt-0 flex flex-col justify-center gap-2"></div>
                    </div>
                    <p class="text-center text-sm text-text-light dark:text-text-dark mt-4">${t('co2Saved', { amount: '1.2' })}</p>
                  </div>
                  
                   <div class="bg-gradient-to-br from-primary-dark to-accent text-white p-5 rounded-xl shadow-lg text-center transition-all hover:shadow-xl hover:-translate-y-1" style="animation-delay: 500ms">
                        <h3 class="font-bold text-lg">Support Our NGO!</h3>
                        <p class="text-sm mt-1 mb-3 opacity-90">Watch a 30-second ad to contribute to our cause. It's optional but greatly appreciated!</p>
                        <button data-action="watch-ad-btn" class="bg-white/90 text-primary-dark font-bold py-2 px-5 rounded-full flex items-center justify-center mx-auto hover:bg-white transition-transform transform hover:scale-105 shadow-md hover:shadow-lg">
                            <i data-lucide="video" class="mr-2"></i> Watch Ad
                        </button>
                   </div>
                </div>`;
            }
            
            function renderAuthHeader() {
                const t = AppState.t.bind(AppState);
                return `
                <div class="flex justify-end items-center mb-4 space-x-4">
                    <div class="relative">
                        <i data-lucide="globe" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-white/70 pointer-events-none" style="width: 16px; height: 16px;"></i>
                        <select id="language-switcher-auth" class="bg-black/20 text-white text-sm font-semibold rounded-full appearance-none pl-8 pr-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-white/50" aria-label="Select language">
                        <option value="en" ${AppState.language === 'en' ? 'selected' : ''}>EN</option>
                        <option value="hi" ${AppState.language === 'hi' ? 'selected' : ''}>HI</option>
                        <option value="bn" ${AppState.language === 'bn' ? 'selected' : ''}>BN</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="sun" class="w-5 h-5 text-yellow-300"></i>
                        <button id="theme-toggle-btn-auth" 
                                class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 mx-2
                                    bg-black/20 dark:bg-accent focus:outline-none focus:ring-2 focus:ring-white/50" 
                                role="switch" 
                                aria-checked="${AppState.theme === 'dark'}">
                        <span class="sr-only">Toggle theme</span>
                        <span class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200 
                                    translate-x-0 dark:translate-x-5"></span>
                        </button>
                        <i data-lucide="moon" class="w-5 h-5 text-slate-300"></i>
                    </div>
                </div>`;
            }

            function renderLoginSelector() {
                const t = AppState.t.bind(AppState);
                return `
                <div class="w-full max-w-md mx-auto">
                    ${renderAuthHeader()}
                    <div class="bg-card-light/80 dark:bg-card-dark/70 backdrop-blur-lg p-8 rounded-2xl shadow-2xl border border-white/20 animate-scale-in">
                        <div class="text-center mb-8 animate-fade-in-down">
                            <div class="flex items-center justify-center mb-2">
                                <i data-lucide="recycle" class="h-12 w-12 text-primary"></i>
                                <h1 class="text-4xl font-bold text-heading-light dark:text-heading-dark ml-2">Eco Track</h1>
                            </div>
                            <p class="text-xs text-text-light dark:text-text-dark">powered by <span class="font-semibold bg-gradient-to-r from-yellow-300 via-amber-400 to-orange-500 text-transparent bg-clip-text bg-size-300 animate-gradient-pan">${NGO_NAME}</span></p>
                        </div>
                        <p class="text-lg text-center text-text-light dark:text-text-dark mb-6 animate-fade-in-up" style="animation-delay: 100ms;">${t('chooseLogin')}</p>
                        <div class="space-y-4">
                            <button data-logintype="user" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-primary-dark transition-all transform hover:scale-105 flex items-center justify-center text-lg animate-fade-in-up" style="animation-delay: 200ms;">
                                <i data-lucide="home" class="mr-3"></i> ${t('householdLogin')}
                            </button>
                            <button data-logintype="staff" class="w-full bg-secondary text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-secondary/80 transition-all transform hover:scale-105 flex items-center justify-center text-lg animate-fade-in-up" style="animation-delay: 300ms;">
                                <i data-lucide="users" class="mr-3"></i> ${t('staffLogin')}
                            </button>
                            <button data-logintype="admin" class="w-full bg-accent text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-accent/80 transition-all transform hover:scale-105 flex items-center justify-center text-lg animate-fade-in-up" style="animation-delay: 400ms;">
                                <i data-lucide="shield-check" class="mr-3"></i> ${t('adminLogin')}
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            function renderPasswordStrengthIndicator(strength, password) {
                const t = AppState.t.bind(AppState);
                const checks = [
                    {key: 'pw8Chars', valid: password.length >= 8},
                    {key: 'pwUppercase', valid: /[A-Z]/.test(password)},
                    {key: 'pwLowercase', valid: /[a-z]/.test(password)},
                    {key: 'pwNumber', valid: /\d/.test(password)},
                    {key: 'pwSpecial', valid: /\W|_/.test(password)},
                ];
                const strengthClass = strength > 3 ? 'strong' : strength > 1 ? 'medium' : 'weak';
                return `
                    <div class="password-strength-meter my-2">
                        <div class="${strength > 0 ? `strength-${strengthClass}` : ''}"></div>
                        <div class="${strength > 1 ? `strength-${strengthClass}` : ''}"></div>
                        <div class="${strength > 2 ? `strength-${strengthClass}` : ''}"></div>
                        <div class="${strength > 3 ? `strength-${strengthClass}` : ''}"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs mt-2">
                    ${checks.map(c => `
                        <div class="flex items-center ${c.valid ? 'text-success' : 'text-text-light dark:text-text-dark'}">
                           <i data-lucide="${c.valid ? 'check' : 'x'}" class="w-3 h-3 mr-1.5"></i> ${t(c.key)}
                        </div>`).join('')}
                    </div>`;
            }
            
            function renderAuthFlow() {
                const { isSignup, step, error, formData, passwordStrength } = AppState.authFlowState;
                const t = AppState.t.bind(AppState);

                const renderBackButton = (action) => `<button type="button" data-authaction="${action}" class="text-sm text-primary hover:underline">&larr; ${t('back')}</button>`;
                const renderError = (err) => err ? `<div class="bg-danger/10 text-danger text-sm p-3 rounded-md animate-fade-in-down">${escapeHTML(err)}</div>` : '';
                
                let contentHTML = '';

                if(isSignup) { // SIGNUP FLOW
                    if (step === 1) { // Step 1: Credentials
                        contentHTML = `
                            <h2 class="text-2xl font-bold mb-1 text-heading-light dark:text-heading-dark">${t('createAccount')}</h2>
                            <p class="text-text-light dark:text-text-dark mb-6">Let's get you started.</p>
                            ${renderError(error)}
                            <form id="signup-step1-form" class="space-y-4">
                                <div><label for="fullName" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('fullName')}</label><input type="text" id="fullName" value="${escapeHTML(formData.name || '')}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div><label for="identifier" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('mobileNumber')}</label><input type="tel" id="identifier" value="${escapeHTML(formData.identifier || '')}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div><label for="email" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('emailAddress')}</label><input type="email" id="email" value="${escapeHTML(formData.email || '')}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div><label for="password" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('password')}</label><input type="password" id="password" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div id="password-strength-container">${renderPasswordStrengthIndicator(passwordStrength, formData.password || '')}</div>
                                <div><label for="confirmPassword" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('confirmPassword')}</label><input type="password" id="confirmPassword" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">${t('next')}</button>
                            </form>
                            <p class="mt-6 text-center text-sm">Already have an account? <button type="button" data-authaction="show-login" class="font-semibold text-primary hover:underline">${t('login')}</button></p>
                        `;
                    } else { // Step 2: Details
                        contentHTML = `
                            <h2 class="text-2xl font-bold mb-1 text-heading-light dark:text-heading-dark">${t('yourDetails')}</h2>
                            <p class="text-text-light dark:text-text-dark mb-6">Just a few more things.</p>
                            ${renderError(error)}
                            <form id="signup-step2-form" class="space-y-4">
                                <div><label for="familySize" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('familyMembers')}</label><input type="number" id="familySize" value="${escapeHTML(formData.familySize || '')}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div><label for="gramPanchayat" class="block text-sm font-medium text-text-light dark:text-text-dark">Gram Panchayat</label>
                                  <select id="gramPanchayat" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                                    ${GRAM_PANCHAYATS.map(gp => `<option value="${gp}" ${formData.gramPanchayat === gp ? 'selected' : ''}>${gp}</option>`).join('')}
                                  </select>
                                </div>
                                <div><label for="area" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('area')}</label><input type="text" id="area" value="${escapeHTML(formData.address?.area || '')}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div><label for="landmark" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('landmark')}</label><input type="text" id="landmark" value="${escapeHTML(formData.address?.landmark || '')}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div><label for="pincode" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('pincode')}</label><input type="text" id="pincode" value="${escapeHTML(formData.address?.pincode || '')}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div class="flex items-center space-x-4 pt-2">
                                    ${renderBackButton('back-to-step1')}
                                    <button type="submit" class="flex-grow bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">${t('completeSignup')}</button>
                                </div>
                            </form>
                        `;
                    }
                } else { // LOGIN FLOW
                    contentHTML = `
                        <h2 class="text-2xl font-bold mb-1 text-heading-light dark:text-heading-dark">${t('welcomeBack')}</h2>
                        <p class="text-text-light dark:text-text-dark mb-6">Log in to your household account.</p>
                        ${renderError(error)}
                        <form id="login-form" class="space-y-4">
                            <div><label for="identifier" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('mobileNumber')}</label><input type="tel" id="identifier" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                            <div><label for="password" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('password')}</label><input type="password" id="password" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                            <div class="flex items-center justify-between"><div class="flex items-center"><input id="remember-me" type="checkbox" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"><label for="remember-me" class="ml-2 block text-sm text-text-light dark:text-text-dark">${t('rememberMe')}</label></div></div>
                            <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">${t('login')}</button>
                        </form>
                        <p class="mt-4 text-center text-xs text-secondary-dark">${t('forgotPassword')}</p>
                        <p class="mt-6 text-center text-sm">Don't have an account? <button type="button" data-authaction="show-signup" class="font-semibold text-primary hover:underline">${t('createAccount')}</button></p>
                    `;
                }

                return `
                <div class="w-full max-w-md mx-auto animate-scale-in">
                    ${renderAuthHeader()}
                     <div class="bg-card-light/80 dark:bg-card-dark/70 backdrop-blur-lg p-8 rounded-2xl shadow-2xl border border-white/20">
                        <div class="text-left mb-6"><button type="button" data-authaction="back-to-selector" class="text-sm text-primary hover:underline">&larr; ${t('back')}</button></div>
                        ${contentHTML}
                         <p class="text-center text-xs text-text-light dark:text-text-dark mt-6">powered by <span class="font-semibold bg-gradient-to-r from-yellow-300 via-amber-400 to-orange-500 text-transparent bg-clip-text bg-size-300 animate-gradient-pan">${NGO_NAME}</span></p>
                    </div>
                </div>`;
            }

            function renderAdminAuthFlow() {
                const { error, otpSent, otpIdentifier, resendTimer, otp } = AppState.authFlowState;
                const t = AppState.t.bind(AppState);
                const renderError = (err) => err ? `<div class="bg-danger/10 text-danger text-sm p-3 rounded-md animate-fade-in-down">${escapeHTML(err)}</div>` : '';
                
                let contentHTML = '';
                if (!otpSent) {
                    contentHTML = `
                        <h2 class="text-2xl font-bold mb-1 text-heading-light dark:text-heading-dark">${t('adminLogin')}</h2>
                        <p class="text-text-light dark:text-text-dark mb-6">${t('adminVerification')}</p>
                        ${renderError(error)}
                        <form id="admin-send-otp-form" class="space-y-4">
                            <div><label for="admin-identifier" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('mobileNumber')}</label><input type="tel" id="admin-identifier" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-accent focus:border-accent"></div>
                            <button type="submit" class="w-full bg-accent text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-accent/80 transition">${t('sendOtp')}</button>
                        </form>
                    `;
                } else {
                    const whatsappUrl = `https://wa.me/91${otpIdentifier}?text=${encodeURIComponent(`Your Eco Track admin login OTP is: ${otp}`)}`;
                    contentHTML = `
                        <h2 class="text-2xl font-bold mb-1 text-heading-light dark:text-heading-dark">${t('verifyOtp')}</h2>
                        <p class="text-text-light dark:text-text-dark mb-2">${t('otpSentTo', { identifier: otpIdentifier })} <button type="button" data-authaction="admin-change-identifier" class="text-xs text-primary hover:underline">(${t('change')})</button></p>
                        
                        <div class="bg-blue-100 dark:bg-blue-900/30 border-l-4 border-blue-500 text-blue-700 dark:text-blue-300 p-3 rounded-r-lg text-sm mb-4" role="alert">
                          <p class="font-bold">Login with WhatsApp:</p>
                          <p class="text-xs mt-1">Click the button below to open WhatsApp with your pre-filled OTP. Just hit send!</p>
                          <a href="${whatsappUrl}" target="_blank" class="mt-2 flex items-center justify-center w-full bg-green-500 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-green-600 transition">
                            <i data-lucide="send" class="w-4 h-4 mr-2"></i> Open in WhatsApp
                          </a>
                        </div>

                        ${renderError(error)}
                        <form id="admin-verify-otp-form" class="space-y-4">
                             <div><label for="admin-otp" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('otpPlaceholder')}</label><input type="tel" id="admin-otp" required maxlength="6" class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-accent focus:border-accent text-center tracking-[0.5em]"></div>
                             <button type="submit" class="w-full bg-accent text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-accent/80 transition">${t('verifyAndProceed')}</button>
                        </form>
                        <div class="mt-4 text-center text-sm">
                            ${resendTimer > 0 ? `<span id="resend-timer" class="text-secondary-dark">${t('resendOtpIn', { count: resendTimer })}</span>` : `<button type="button" id="resend-btn" data-authaction="admin-resend-otp" class="text-primary hover:underline">${t('resendOtp')}</button>`}
                        </div>
                    `;
                }

                return `
                <div class="w-full max-w-md mx-auto animate-scale-in">
                    ${renderAuthHeader()}
                    <div class="bg-card-light/80 dark:bg-card-dark/70 backdrop-blur-lg p-8 rounded-2xl shadow-2xl border border-white/20">
                        <div class="text-left mb-6"><button type="button" data-authaction="back-to-selector" class="text-sm text-primary hover:underline">&larr; ${t('back')}</button></div>
                        ${contentHTML}
                         <p class="text-center text-xs text-text-light dark:text-text-dark mt-6">powered by <span class="font-semibold bg-gradient-to-r from-yellow-300 via-amber-400 to-orange-500 text-transparent bg-clip-text bg-size-300 animate-gradient-pan">${NGO_NAME}</span></p>
                    </div>
                </div>`;
            }

            function renderStaffAuthFlow() {
                const { error } = AppState.authFlowState;
                const t = AppState.t.bind(AppState);
                const renderError = (err) => err ? `<div class="bg-danger/10 text-danger text-sm p-3 rounded-md animate-fade-in-down">${escapeHTML(err)}</div>` : '';
                
                let contentHTML = `
                    <h2 class="text-2xl font-bold mb-1 text-heading-light dark:text-heading-dark">${t('staffLogin')}</h2>
                    <p class="text-text-light dark:text-text-dark mb-6">${t('staffVerification')}</p>
                    ${renderError(error)}
                    <form id="staff-login-form" class="space-y-4">
                        <div><label for="staff-identifier" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('mobileNumber')}</label><input type="tel" id="staff-identifier" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-secondary focus:border-secondary"></div>
                        <button type="submit" class="w-full bg-secondary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-secondary/80 transition">${t('login')}</button>
                    </form>
                `;

                return `
                <div class="w-full max-w-md mx-auto animate-scale-in">
                    ${renderAuthHeader()}
                    <div class="bg-card-light/80 dark:bg-card-dark/70 backdrop-blur-lg p-8 rounded-2xl shadow-2xl border border-white/20">
                        <div class="text-left mb-6"><button type="button" data-authaction="back-to-selector" class="text-sm text-primary hover:underline">&larr; ${t('back')}</button></div>
                        ${contentHTML}
                         <p class="text-center text-xs text-text-light dark:text-text-dark mt-6">powered by <span class="font-semibold bg-gradient-to-r from-yellow-300 via-amber-400 to-orange-500 text-transparent bg-clip-text bg-size-300 animate-gradient-pan">${NGO_NAME}</span></p>
                    </div>
                </div>`;
            }

            function renderAdminUserManagement() {
                const t = AppState.t.bind(AppState);
                const users = AppState.users;
                return `
                    <div class="animate-fade-in-up">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark">User Management</h2>
                            <div class="w-full md:w-auto flex flex-col md:flex-row items-center gap-2">
                                <div class="relative w-full md:w-64">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-secondary-dark"></i>
                                    <input type="search" id="user-search-input" placeholder="Search by name or ID..." class="w-full pl-9 pr-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-sm">
                                </div>
                                <select id="user-role-filter" class="w-full md:w-auto px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-sm">
                                    <option value="">All Roles</option>
                                    <option value="household">Household</option>
                                    <option value="admin">Admin</option>
                                    <option value="captain">Captain</option>
                                    <option value="employee">Employee</option>
                                    <option value="sanitaryworker">Sanitary Worker</option>
                                </select>
                                <button data-action="add-staff" class="w-full md:w-auto bg-primary text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-primary-dark transition text-sm flex items-center justify-center">
                                    <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> ${t('addStaffMember')}
                                </button>
                            </div>
                        </div>
                        <div id="user-list-container" class="space-y-4">
                        ${users.map(user => {
                            const userPayments = AppState.payments.filter(p => p.householdId === user.householdId);
                            const roleColor = { admin: 'bg-accent/20 text-accent-dark', household: 'bg-primary/20 text-primary-dark', captain: 'bg-yellow-500/20 text-yellow-600', employee: 'bg-blue-500/20 text-blue-600', sanitaryworker: 'bg-purple-500/20 text-purple-600'}[user.role] || 'bg-gray-500/20 text-gray-600';
                            return `
                                <div class="user-card bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-md border border-border-light dark:border-border-dark" data-name="${user.name.toLowerCase()}" data-id="${user.householdId.toLowerCase()}" data-role="${user.role}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg text-heading-light dark:text-heading-dark">${escapeHTML(user.name)}</p>
                                            <p class="text-sm text-secondary-dark">${user.householdId}</p>
                                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${roleColor}">${user.role}</span>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm font-medium ${user.status === 'active' ? 'text-success' : 'text-danger'}">${user.status.charAt(0).toUpperCase() + user.status.slice(1)}</p>
                                            <p class="text-xs text-secondary-dark">Balance: ₹${user.outstandingBalance.toFixed(2)}</p>
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><strong>Email:</strong> <a href="mailto:${escapeHTML(user.email)}" class="text-primary hover:underline">${escapeHTML(user.email)}</a></div>
                                        <div><strong>Mobile:</strong> ${escapeHTML(user.identifier)}</div>
                                        <div><strong>Last Login:</strong> ${formatDateTime(user.lastLoginTime)}</div>
                                        <div><strong>Last IP:</strong> ${user.lastIpAddress || 'N/A'}</div>
                                        <div class="col-span-1 md:col-span-2">
                                            <strong>Password:</strong>
                                            <div class="flex items-center">
                                                <input type="password" value="${escapeHTML(user.password)}" readonly class="flex-grow bg-transparent text-text-light dark:text-text-dark" id="pass-${user.householdId}">
                                                <button type="button" data-password-toggle="${user.householdId}" class="p-1 text-secondary-dark hover:text-primary"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                        <div class="col-span-1 md:col-span-2">
                                            <strong>Payment History (${userPayments.length}):</strong>
                                            ${userPayments.length > 0 ? `
                                                <ul class="list-disc list-inside text-xs mt-1">
                                                    ${userPayments.slice(0, 3).map(p => `<li>${formatDateTime(p.date)} - ₹${p.amount.toFixed(2)} (${p.status})</li>`).join('')}
                                                    ${userPayments.length > 3 ? `<li>...and ${userPayments.length - 3} more</li>` : ''}
                                                </ul>
                                            ` : '<p class="text-xs text-secondary-dark mt-1">No payments found.</p>'}
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark flex items-center space-x-2">
                                         <button data-action="admin-message-user" data-user-id="${user.householdId}" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Message</button>
                                         <button data-action="admin-edit-user" data-user-id="${user.householdId}" class="text-xs bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
                                         <button data-action="admin-toggle-block" data-user-id="${user.householdId}" class="text-xs ${user.status === 'active' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white px-3 py-1 rounded">
                                            ${user.status === 'active' ? 'Block' : 'Unblock'}
                                         </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        </div>
                    </div>
                `;
            }
            
            function renderAdminBookingManagement() {
                const bookings = AppState.bookings.sort((a,b) => new Date(b.date) - new Date(a.date));
                const getStatusPill = (status) => {
                    const statusMap = {
                        'Completed': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
                        'Scheduled': 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300',
                        'Pending Approval': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300',
                        'Rejected': 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'
                    };
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusMap[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
                };

                return `
                    <div class="animate-fade-in-up">
                        <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark mb-6">Booking Management</h2>
                        <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-md border border-border-light dark:border-border-dark">
                          <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-text-light dark:text-text-dark">
                                <thead class="text-xs text-secondary-dark uppercase bg-background-light dark:bg-background-dark">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">User</th>
                                        <th scope="col" class="px-6 py-3">Date & Time</th>
                                        <th scope="col" class="px-6 py-3">Waste Type</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${bookings.map(booking => {
                                        const user = AppState.users.find(u => u.householdId === booking.householdId);
                                        return `
                                        <tr class="border-b border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-card-dark/50">
                                            <td class="px-6 py-4 font-medium text-heading-light dark:text-heading-dark whitespace-nowrap">${user ? user.name : 'Unknown User'}</td>
                                            <td class="px-6 py-4">${booking.date} (${booking.timeSlot})</td>
                                            <td class="px-6 py-4">${booking.wasteType}</td>
                                            <td class="px-6 py-4">${getStatusPill(booking.status)}</td>
                                            <td class="px-6 py-4">
                                                ${booking.status === 'Pending Approval' ? `
                                                    <div class="flex space-x-2">
                                                        <button data-booking-action="approve" data-booking-id="${booking.id}" class="text-xs bg-success text-white px-2 py-1 rounded hover:bg-green-600">Approve</button>
                                                        <button data-booking-action="reject" data-booking-id="${booking.id}" class="text-xs bg-danger text-white px-2 py-1 rounded hover:bg-red-600">Reject</button>
                                                    </div>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                    ${bookings.length === 0 ? `<tr><td colspan="5" class="text-center py-8">No bookings found.</td></tr>` : ''}
                                </tbody>
                            </table>
                          </div>
                        </div>
                    </div>
                `;
            }
            
            function renderAdminComplaintManagement() {
                 const complaints = AppState.complaints.sort((a,b) => new Date(b.date) - new Date(a.date));
                 const getStatusPill = (status) => {
                    const statusMap = {
                        'Resolved': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
                        'In Progress': 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300',
                        'Pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300'
                    };
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusMap[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
                };

                return `
                    <div class="animate-fade-in-up">
                        <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark mb-6">Complaint Management</h2>
                         <div class="space-y-4">
                        ${complaints.map(c => {
                            const user = AppState.users.find(u => u.householdId === c.householdId);
                            return `
                                <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-md border border-border-light dark:border-border-dark">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg text-heading-light dark:text-heading-dark">${escapeHTML(c.issue)}</p>
                                            <p class="text-sm text-secondary-dark">By: ${user ? user.name : 'Unknown'} on ${formatDateTime(c.date)}</p>
                                        </div>
                                        ${getStatusPill(c.status)}
                                    </div>
                                    <p class="mt-2 text-text-light dark:text-text-dark text-sm">${escapeHTML(c.details)}</p>
                                    <div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark flex items-center space-x-2">
                                         <select data-complaint-action="status" data-complaint-id="${c.id}" class="text-xs bg-gray-100 dark:bg-gray-700 border border-border-light dark:border-border-dark rounded px-2 py-1">
                                            <option value="Pending" ${c.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="In Progress" ${c.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="Resolved" ${c.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                         </select>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                         ${complaints.length === 0 ? `<p class="text-center py-8">No complaints found.</p>` : ''}
                        </div>
                    </div>
                `;
            }

            function renderAdminBroadcast() {
                return `
                    <div class="animate-fade-in-up">
                        <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark mb-6">Send Broadcast Message</h2>
                        <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                            <p class="text-text-light dark:text-text-dark mb-4 text-sm">This message will be shown as a pop-up to all household users when they open the app.</p>
                            <form id="broadcast-form" class="space-y-4">
                                <div>
                                    <label for="broadcast-message" class="block text-sm font-medium text-text-light dark:text-text-dark">Message</label>
                                    <textarea id="broadcast-message" rows="4" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">${escapeHTML(AppState.broadcastMessage || '')}</textarea>
                                </div>
                                <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">Update & Send Broadcast</button>
                            </form>
                        </div>
                    </div>
                `;
            }

            function renderAdminSellRequestManagement() {
                const requests = AppState.sellRequests.sort((a,b) => new Date(b.date) - new Date(a.date));
                 const getStatusPill = (status) => {
                    const statusMap = {
                        'Completed': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
                        'Approved': 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300',
                        'Pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300',
                        'Rejected': 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'
                    };
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusMap[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
                };

                return `
                    <div class="animate-fade-in-up">
                        <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark mb-6">Sell Requests</h2>
                        <div class="space-y-4">
                        ${requests.map(req => {
                            const user = AppState.users.find(u => u.householdId === req.householdId);
                            const materials = Object.entries(req.materials).map(([key, val]) => `${key.charAt(0).toUpperCase() + key.slice(1)} (${val}kg)`).join(', ');
                            return `
                                <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-md border border-border-light dark:border-border-dark">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg text-heading-light dark:text-heading-dark">Request #${req.id.slice(-4)}</p>
                                            <p class="text-sm text-secondary-dark">By: ${user ? user.name : 'Unknown'} on ${formatDateTime(req.date)}</p>
                                        </div>
                                        ${getStatusPill(req.status)}
                                    </div>
                                    <div class="mt-2 text-text-light dark:text-text-dark text-sm space-y-1">
                                        <p><strong>Materials:</strong> ${materials}</p>
                                        <p><strong>Total Weight:</strong> ${req.weightKg} kg</p>
                                        <p><strong>Estimated Cost:</strong> ₹${req.estimatedCost.toFixed(2)}</p>
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark">
                                        ${req.status === 'Pending' ? `
                                            <form class="flex items-end space-x-2" data-action="approve-sell-request" data-request-id="${req.id}">
                                                <div class="flex-grow">
                                                    <label for="cost-${req.id}" class="text-xs font-medium">Estimated Cost (₹)</label>
                                                    <input type="number" id="cost-${req.id}" required class="w-full text-sm p-1 bg-transparent border-b border-border-light dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary">
                                                </div>
                                                <button type="submit" class="text-xs bg-success text-white px-3 py-1.5 rounded hover:bg-green-600">Approve</button>
                                            </form>
                                        ` : `
                                            <div class="flex items-center space-x-2">
                                                <button data-action="view-sell-chat" data-request-id="${req.id}" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">View Chat</button>
                                                ${req.status !== 'Completed' ? `<button data-action="complete-sell-request" data-request-id="${req.id}" class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-primary-dark">Mark as Completed</button>` : ''}
                                            </div>
                                        `}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                         ${requests.length === 0 ? `<p class="text-center py-8">No sell requests found.</p>` : ''}
                        </div>
                    </div>
                `;
            }

            function renderAdminPaymentManagement() {
                const payments = AppState.payments.sort((a, b) => new Date(b.date) - new Date(a.date));
                const getStatusPill = (status) => {
                    const statusMap = {
                        'Paid': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
                        'Pending Verification': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300',
                        'Rejected': 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'
                    };
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusMap[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
                };

                return `
                    <div class="animate-fade-in-up">
                        <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark mb-6">Payment Management</h2>
                        <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-md border border-border-light dark:border-border-dark">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-text-light dark:text-text-dark">
                                    <thead class="text-xs text-secondary-dark uppercase bg-background-light dark:bg-background-dark">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">User</th>
                                            <th scope="col" class="px-6 py-3">Date</th>
                                            <th scope="col" class="px-6 py-3">Amount</th>
                                            <th scope="col" class="px-6 py-3">Status</th>
                                            <th scope="col" class="px-6 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${payments.map(p => {
                                            const user = AppState.users.find(u => u.householdId === p.householdId);
                                            return `
                                            <tr class="border-b border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-card-dark/50">
                                                <td class="px-6 py-4 font-medium text-heading-light dark:text-heading-dark whitespace-nowrap">${user ? user.name : 'Unknown User'}</td>
                                                <td class="px-6 py-4">${formatDateTime(p.date)}</td>
                                                <td class="px-6 py-4">₹${p.amount.toFixed(2)}</td>
                                                <td class="px-6 py-4">${getStatusPill(p.status)}</td>
                                                <td class="px-6 py-4">
                                                    ${p.status === 'Pending Verification' ? `
                                                        <div class="flex space-x-2">
                                                            <button data-action="view-screenshot" data-payment-id="${p.id}" class="text-xs bg-info text-white px-2 py-1 rounded hover:bg-blue-600">Screenshot</button>
                                                            <button data-action="approve-payment" data-payment-id="${p.id}" class="text-xs bg-success text-white px-2 py-1 rounded hover:bg-green-600">Approve</button>
                                                            <button data-action="reject-payment" data-payment-id="${p.id}" class="text-xs bg-danger text-white px-2 py-1 rounded hover:bg-red-600">Reject</button>
                                                        </div>
                                                    ` : '-'}
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                        ${payments.length === 0 ? `<tr><td colspan="5" class="text-center py-8">No payments found.</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderAdminApp() {
                const user = AppState.currentUser();
                if (!user) {
                    AppState.logout();
                    render();
                    return;
                }
                const t = AppState.t.bind(AppState);
                const navItems = [
                    { view: AdminView.Dashboard, icon: 'layout-dashboard', label: 'Dashboard' },
                    { view: AdminView.Users, icon: 'users', label: 'Users' },
                    { view: AdminView.Bookings, icon: 'calendar-check', label: 'Bookings' },
                    { view: AdminView.SellRequests, icon: 'shopping-cart', label: 'Sell Requests' },
                    { view: AdminView.Payments, icon: 'indian-rupee', label: 'Payments' },
                    { view: AdminView.Complaints, icon: 'message-square-warning', label: 'Complaints' },
                    { view: AdminView.Broadcast, icon: 'radio', label: 'Broadcast' },
                ];
                
                let mainContent = '';
                switch(AppState.currentAdminView) {
                    case AdminView.Users: mainContent = renderAdminUserManagement(); break;
                    case AdminView.Bookings: mainContent = renderAdminBookingManagement(); break;
                    case AdminView.Complaints: mainContent = renderAdminComplaintManagement(); break;
                    case AdminView.Broadcast: mainContent = renderAdminBroadcast(); break;
                    case AdminView.SellRequests: mainContent = renderAdminSellRequestManagement(); break;
                    case AdminView.Payments: mainContent = renderAdminPaymentManagement(); break;
                    default: mainContent = `<p>Welcome to the Admin Dashboard, ${escapeHTML(user.name)}. Please select a module to manage.</p>`;
                }

                return `
                <div class="flex h-screen bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">
                    <aside class="w-64 bg-card-light dark:bg-card-dark border-r border-border-light dark:border-border-dark flex flex-col">
                        <div class="p-4 border-b border-border-light dark:border-border-dark flex items-center space-x-2">
                            <i data-lucide="shield-check" class="text-accent h-8 w-8"></i>
                            <div>
                                <h1 class="text-xl font-bold text-heading-light dark:text-heading-dark">Admin Panel</h1>
                                <p class="text-xs text-secondary-dark">Eco Track</p>
                            </div>
                        </div>
                        <nav class="flex-grow p-4 space-y-2">
                            ${navItems.map(item => `
                                <button data-adminview="${item.view}" class="w-full flex items-center space-x-3 px-3 py-2 rounded-md text-sm font-medium transition-colors ${AppState.currentAdminView === item.view ? 'bg-primary/10 text-primary' : 'hover:bg-primary/5'}">
                                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                                    <span>${item.label}</span>
                                </button>
                            `).join('')}
                        </nav>
                         <div class="p-4 border-t border-border-light dark:border-border-dark">
                            <div class="flex items-center space-x-3 mb-4">
                               <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center font-bold text-primary text-lg">${getUserInitials(user.name)}</div>
                               <div>
                                 <p class="font-semibold text-heading-light dark:text-heading-dark">${escapeHTML(user.name)}</p>
                                 <p class="text-xs text-secondary-dark">${escapeHTML(user.email)}</p>
                               </div>
                            </div>
                            <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-danger/10 text-danger hover:bg-danger/20">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>Logout</span>
                            </button>
                        </div>
                    </aside>
                    <main class="flex-grow p-6 overflow-y-auto">
                        ${mainContent}
                    </main>
                </div>
                `;
            }

            function renderStaffApp(user) {
                const t = AppState.t.bind(AppState);
                const isTracking = locationWatchId !== null;
                const attendanceColor = user.attendanceStatus === 'present' ? 'text-success' : 'text-danger';
                const roleDisplay = t(`role_${user.role}`);
                const now = new Date();
                const hour = now.getHours();
                const isWorkHours = hour >= 10 && hour < 16;


                return `
                <div class="w-full max-w-lg mx-auto bg-background-light dark:bg-background-dark shadow-2xl flex flex-col h-screen font-sans">
                    <header class="bg-gradient-to-r from-secondary to-slate-600 text-white p-4 shadow-lg w-full max-w-lg mx-auto sticky top-0 z-20">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    ${user.profilePicture ? 
                                        `<img src="${user.profilePicture}" alt="Profile" class="h-10 w-10 rounded-full object-cover border-2 border-white/50">` : 
                                        `<div class="h-10 w-10 rounded-full bg-secondary/80 flex items-center justify-center font-bold text-white text-lg border-2 border-white/50">${getUserInitials(user.name)}</div>`
                                    }
                                </div>
                                <div>
                                    <h1 class="text-xl font-bold">${escapeHTML(user.name)}</h1>
                                    <p class="text-xs opacity-80">${roleDisplay}</p>
                                </div>
                            </div>
                            <button id="logout-btn" class="flex items-center space-x-2 px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-black/20 hover:bg-black/40">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                <span>${t('logout')}</span>
                            </button>
                        </div>
                    </header>
                    <main class="flex-grow p-4 md:p-6 overflow-y-auto hide-scrollbar">
                        <div class="space-y-6 animate-fade-in-up">
                            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                                <h3 class="font-semibold text-lg text-heading-light dark:text-heading-dark">Your Status</h3>
                                <div class="mt-2 text-sm space-y-2">
                                    <p><strong>Gram Panchayat:</strong> ${escapeHTML(user.gramPanchayat)}</p>
                                    <p><strong>Attendance:</strong> <span class="font-bold ${attendanceColor}">${user.attendanceStatus.charAt(0).toUpperCase() + user.attendanceStatus.slice(1)}</span></p>
                                    <p><strong>Logged In At:</strong> ${formatDateTime(user.lastLoginTime)}</p>
                                </div>
                            </div>
                             <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-md border border-border-light dark:border-border-dark text-center">
                                <h3 class="font-semibold text-xl text-heading-light dark:text-heading-dark mb-2">Live Location Tracking</h3>
                                <p class="text-sm text-text-light dark:text-text-dark mb-4">You must share your location during work hours (10 AM - 4 PM) for daily operations.</p>
                                
                                <div class="flex items-center justify-center space-x-2 mb-6">
                                    <span id="tracking-status-indicator" class="w-3 h-3 rounded-full ${isTracking ? 'bg-success animate-pulse' : 'bg-danger'}"></span>
                                    <span id="tracking-status-text" class="font-semibold ${isTracking ? 'text-success' : 'text-danger'}">${isTracking ? 'Tracking Active' : 'Tracking Inactive'}</span>
                                </div>
                                
                                ${isWorkHours ? `
                                    <button id="toggle-tracking-btn" class="w-full font-bold py-3 px-4 rounded-lg shadow-lg transition-all transform hover:scale-105 text-lg flex items-center justify-center text-white ${isTracking ? 'bg-danger hover:bg-red-600' : 'bg-success hover:bg-green-600'}">
                                        ${isTracking ? '<i data-lucide="pause-circle" class="mr-3"></i> End Work Day' : '<i data-lucide="play-circle" class="mr-3"></i> Start Work Day'}
                                    </button>
                                ` : `
                                    <div class="text-sm bg-yellow-100 dark:bg-yellow-900/40 text-yellow-800 dark:text-yellow-300 p-3 rounded-lg">
                                        Tracking is only available during work hours (10 AM - 4 PM).
                                    </div>
                                `}
                            </div>
                        </div>
                    </main>
                </div>
                `;
            }

            function renderBookingView(user) {
                const t = AppState.t.bind(AppState);
                const userBookings = AppState.bookings.filter(b => b.householdId === user.householdId).sort((a,b) => new Date(b.date) - new Date(a.date));
                const getStatusPill = (status) => {
                    const statusMap = {
                        'Completed': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
                        'Scheduled': 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300',
                        'Pending Approval': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300',
                        'Rejected': 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'
                    };
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusMap[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
                };

                return `
                <div class="space-y-6 animate-fade-in-up">
                    <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                        <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark mb-1">${t('bookECart')}</h2>
                        <p class="text-text-light dark:text-text-dark mb-6">${t('bookECartDesc')}</p>
                        <form id="booking-form" class="space-y-4">
                            <div>
                                <label for="waste-type" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('wasteType')}</label>
                                <select id="waste-type" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                                    <option>Bulk Waste (Furniture, etc.)</option>
                                    <option>E-Waste (Electronics)</option>
                                    <option>Garden Waste</option>
                                    <option>Construction Debris</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="booking-date" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('date')}</label>
                                    <input type="date" id="booking-date" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" min="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div>
                                    <label for="time-slot" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('timeSlot')}</label>
                                    <select id="time-slot" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                                        <option>Morning (9am-12pm)</option>
                                        <option>Afternoon (1pm-4pm)</option>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label for="booking-notes" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('notes')}</label>
                                <textarea id="booking-notes" rows="2" class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="e.g., one large sofa"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">${t('bookNow')}</button>
                        </form>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-heading-light dark:text-heading-dark mb-4">${t('myBookings')}</h3>
                        <div class="space-y-3">
                            ${userBookings.length > 0 ? userBookings.map(b => `
                                <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-sm border border-border-light dark:border-border-dark flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-heading-light dark:text-heading-dark">${b.wasteType}</p>
                                        <p class="text-sm text-secondary-dark">${new Date(b.date).toLocaleDateString()} - ${b.timeSlot}</p>
                                    </div>
                                    ${getStatusPill(b.status)}
                                </div>
                            `).join('') : `<p class="text-center text-text-light dark:text-text-dark py-4">${t('noBookings')}</p>`}
                        </div>
                    </div>
                </div>
                `;
            }
            
            function renderComplaintsView(user) {
                const t = AppState.t.bind(AppState);
                const userComplaints = AppState.complaints.filter(c => c.householdId === user.householdId).sort((a,b) => new Date(b.date) - new Date(a.date));
                 const getStatusPill = (status) => {
                    const statusMap = {
                        'Resolved': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
                        'In Progress': 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300',
                        'Pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300'
                    };
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusMap[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
                };
                return `
                <div class="space-y-6 animate-fade-in-up">
                    <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                        <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark mb-1">${t('submitComplaint')}</h2>
                        <p class="text-text-light dark:text-text-dark mb-6">We're sorry you had a problem. Please let us know what happened.</p>
                        <form id="complaint-form" class="space-y-4">
                            <div>
                                <label for="issue-type" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('issueType')}</label>
                                <select id="issue-type" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                                    <option>Missed Pickup</option>
                                    <option>Driver Behavior</option>
                                    <option>Payment Issue</option>
                                    <option>Waste Spillage</option>
                                    <option>Other</option>
                                </select>
                            </div>
                             <div>
                                <label for="complaint-details" class="block text-sm font-medium text-text-light dark:text-text-dark">${t('details')}</label>
                                <textarea id="complaint-details" rows="3" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Please provide as much detail as possible..."></textarea>
                            </div>
                            <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">${t('submit')}</button>
                        </form>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-heading-light dark:text-heading-dark mb-4">${t('myComplaints')}</h3>
                        <div class="space-y-3">
                            ${userComplaints.length > 0 ? userComplaints.map(c => `
                                <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-sm border border-border-light dark:border-border-dark">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-heading-light dark:text-heading-dark">${c.issue}</p>
                                            <p class="text-sm text-secondary-dark">${new Date(c.date).toLocaleDateString()}</p>
                                        </div>
                                        ${getStatusPill(c.status)}
                                    </div>
                                    <p class="mt-2 text-sm text-text-light dark:text-text-dark text-ellipsis overflow-hidden">${c.details}</p>
                                </div>
                            `).join('') : `<p class="text-center text-text-light dark:text-text-dark py-4">${t('noComplaints')}</p>`}
                        </div>
                    </div>
                </div>`;
            }
            
            function renderHistoryView(user) {
                const t = AppState.t.bind(AppState);
                const userPayments = AppState.payments.filter(p => p.householdId === user.householdId).map(p => ({...p, type: 'payment'}));
                const userBookings = AppState.bookings.filter(b => b.householdId === user.householdId).map(b => ({...b, type: 'booking'}));
                const userComplaints = AppState.complaints.filter(c => c.householdId === user.householdId).map(c => ({...c, type: 'complaint'}));

                const historyItems = [...userPayments, ...userBookings, ...userComplaints].sort((a,b) => new Date(b.date) - new Date(a.date));

                const renderHistoryItem = (item) => {
                    switch(item.type) {
                        case 'payment': return `<div class="flex items-center space-x-4"><div class="p-2 bg-primary/10 rounded-full"><i data-lucide="indian-rupee" class="text-primary"></i></div><div><p class="font-semibold text-heading-light dark:text-heading-dark">Payment ${item.status}</p><p class="text-sm text-secondary-dark">₹${item.amount.toFixed(2)} - ${new Date(item.date).toLocaleDateString()}</p></div></div>`;
                        case 'booking': return `<div class="flex items-center space-x-4"><div class="p-2 bg-accent/10 rounded-full"><i data-lucide="calendar-check" class="text-accent"></i></div><div><p class="font-semibold text-heading-light dark:text-heading-dark">${item.wasteType} Booking</p><p class="text-sm text-secondary-dark">${item.status} - ${new Date(item.date).toLocaleDateString()}</p></div></div>`;
                        case 'complaint': return `<div class="flex items-center space-x-4"><div class="p-2 bg-danger/10 rounded-full"><i data-lucide="message-square-warning" class="text-danger"></i></div><div><p class="font-semibold text-heading-light dark:text-heading-dark">Complaint: ${item.issue}</p><p class="text-sm text-secondary-dark">${item.status} - ${new Date(item.date).toLocaleDateString()}</p></div></div>`;
                        default: return '';
                    }
                };

                return `<div class="space-y-4 animate-fade-in-up">
                    <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark">Activity History</h2>
                    ${historyItems.length > 0 ? historyItems.map(item => `
                        <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-sm border border-border-light dark:border-border-dark">${renderHistoryItem(item)}</div>
                    `).join('') : `<p class="text-center text-text-light dark:text-text-dark py-8">No history found.</p>`}
                </div>`;
            }

            function renderProfileView(user) {
                const t = AppState.t.bind(AppState);
                const faqs = [
                    { q: "How do I pay my monthly bill?", a: "You can pay your bill through the 'Pay' tab on the dashboard. We accept UPI payments." },
                    { q: "What should I do if my waste is not collected?", a: "Please file a complaint under the 'Complaints' tab with the 'Missed Pickup' category. We will investigate immediately." },
                    { q: "How does waste segregation work?", a: "Please separate your waste into three categories: Wet (kitchen waste), Dry (plastic, paper, glass), and Hazardous (batteries, medical waste)." },
                ];
                return `
                <div class="space-y-6 animate-fade-in-up">
                    <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                    
                    <div class="text-center">
                        <div class="relative w-28 h-28 mx-auto">
                            <button id="profile-pic-btn" class="w-full h-full rounded-full group relative" title="Change profile picture">
                            ${user.profilePicture ? 
                                `<img src="${user.profilePicture}" alt="Profile" class="w-28 h-28 rounded-full object-cover border-4 border-card-light dark:border-card-dark shadow-lg">` : 
                                `<div class="w-28 h-28 rounded-full bg-primary/20 flex items-center justify-center font-bold text-primary text-5xl border-4 border-card-light dark:border-card-dark shadow-lg">${getUserInitials(user.name)}</div>`
                            }
                            <div class="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="camera" class="text-white w-8 h-8"></i>
                            </div>
                            <div class="absolute bottom-1 right-1 bg-primary text-white rounded-full p-2 border-2 border-card-light dark:border-card-dark group-hover:scale-110 transition-transform">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                            </div>
                            </button>
                        </div>
                        <h2 class="text-2xl font-bold mt-4 text-heading-light dark:text-heading-dark">${escapeHTML(user.name)}</h2>
                        <p class="text-secondary-dark">${user.householdId}</p>
                    </div>

                    <!-- Personal Details -->
                    <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-lg text-heading-light dark:text-heading-dark">${t('personalDetails')}</h3>
                            <button data-action="edit-profile" class="text-sm font-medium text-primary hover:underline flex items-center"><i data-lucide="edit-2" class="w-3 h-3 mr-1"></i> ${t('editProfile')}</button>
                        </div>
                        <div class="space-y-2 text-sm">
                           <p><strong>${t('mobileNumber')}:</strong> ${escapeHTML(user.identifier)}</p>
                           <p><strong>${t('emailAddress')}:</strong> ${escapeHTML(user.email)}</p>
                           <p><strong>Address:</strong> ${escapeHTML(user.address.area)}, ${escapeHTML(user.address.landmark)}, ${escapeHTML(user.address.pincode)}</p>
                        </div>
                    </div>

                    <!-- Settings -->
                     <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                        <h3 class="font-semibold text-lg text-heading-light dark:text-heading-dark mb-3">Settings & Reports</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <label for="push-notifications" class="font-medium text-text-light dark:text-text-dark">Push Notifications</label>
                                <button data-action="toggle-push"
                                        class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200
                                               ${user.pushNotificationsEnabled ? 'bg-primary' : 'bg-gray-300 dark:bg-gray-600'} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary focus:ring-offset-card-light dark:focus:ring-offset-card-dark" 
                                        role="switch" 
                                        aria-checked="${user.pushNotificationsEnabled}">
                                  <span class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200 
                                               ${user.pushNotificationsEnabled ? 'translate-x-5' : 'translate-x-0'}"></span>
                                </button>
                            </div>
                             <div class="pt-3 border-t border-border-light dark:border-border-dark">
                                 <button data-action="download-history" class="w-full text-left font-medium text-text-light dark:text-text-dark py-2 flex items-center hover:text-primary transition-colors"><i data-lucide="download" class="w-4 h-4 mr-2"></i>Download Payment History (PDF)</button>
                             </div>
                             <div class="pt-3 border-t border-border-light dark:border-border-dark">
                                 <button data-view="${ViewType.Complaints}" class="w-full text-left font-medium text-text-light dark:text-text-dark py-2 flex items-center hover:text-primary transition-colors"><i data-lucide="message-square-warning" class="w-4 h-4 mr-2"></i>File a Complaint</button>
                             </div>
                        </div>
                    </div>


                    <!-- FAQ -->
                    <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                        <h3 class="font-semibold text-lg text-heading-light dark:text-heading-dark mb-3">${t('faq')}</h3>
                        <div class="space-y-3">
                            ${faqs.map((faq, index) => `
                                <details>
                                    <summary class="font-medium text-text-light dark:text-text-dark cursor-pointer">${faq.q}</summary>
                                    <p class="text-sm text-secondary-dark pt-2 pl-4 border-l-2 border-primary/50 ml-2">${faq.a}</p>
                                </details>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- App Feedback -->
                    <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                         <h3 class="font-semibold text-lg text-heading-light dark:text-heading-dark mb-3">${t('appFeedback')}</h3>
                         <form id="feedback-form" class="space-y-3">
                            <textarea id="feedback-comments" rows="3" required class="w-full text-sm px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="${t('comments')}..."></textarea>
                            <button type="submit" class="w-full bg-primary text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">${t('submitFeedback')}</button>
                         </form>
                    </div>

                    <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 py-2.5 rounded-lg text-danger bg-danger/10 hover:bg-danger/20 transition-colors font-semibold">
                        <i data-lucide="log-out" class="w-5 h-5"></i><span>${t('logout')}</span>
                    </button>
                </div>`;
            }

            function renderTrackView(user) {
                const t = AppState.t.bind(AppState);
                const staffRoles = ['captain', 'employee', 'sanitaryworker'];
                const TEN_MINUTES_IN_MS = 10 * 60 * 1000;
                const assignedStaff = AppState.users.find(u => 
                    staffRoles.includes(u.role) && 
                    u.gramPanchayat === user.gramPanchayat &&
                    u.attendanceStatus === 'present' &&
                    u.lastLocation &&
                    u.lastLocationUpdate && (new Date().getTime() - new Date(u.lastLocationUpdate).getTime()) < TEN_MINUTES_IN_MS
                );

                return `
                <div class="space-y-6 animate-fade-in-up">
                    <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark">Track Collection Vehicle</h2>
                    <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                        ${assignedStaff ? `
                             <div class="flex items-center space-x-4 mb-4">
                                ${assignedStaff.profilePicture ? `<img src="${assignedStaff.profilePicture}" alt="Driver" class="w-16 h-16 rounded-full object-cover">` : `<div class="w-16 h-16 rounded-full bg-secondary flex items-center justify-center font-bold text-white text-3xl">${getUserInitials(assignedStaff.name)}</div>`}
                                <div>
                                    <p class="text-lg font-semibold text-heading-light dark:text-heading-dark">${assignedStaff.name}</p>
                                    <p class="text-sm text-secondary-dark">Your collection captain</p>
                                </div>
                            </div>
                            <div class="text-sm text-text-light dark:text-text-dark space-y-2 mb-4">
                                <p><strong>Status:</strong> <span class="text-success font-semibold">On Route</span></p>
                                <p><strong>Estimated Arrival:</strong> ${Math.floor(Math.random() * 10) + 5}-${Math.floor(Math.random() * 10) + 15} minutes</p>
                                <p><strong>Last Updated:</strong> ${formatDateTime(assignedStaff.lastLocationUpdate)}</p>
                            </div>
                            <div class="w-full h-64 rounded-lg overflow-hidden border border-border-light dark:border-border-dark">
                               <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q=${assignedStaff.lastLocation.lat},${assignedStaff.lastLocation.lng}&z=15&output=embed"></iframe>
                            </div>
                            <a href="https://www.google.com/maps?q=${assignedStaff.lastLocation.lat},${assignedStaff.lastLocation.lng}" target="_blank" class="mt-4 inline-flex items-center justify-center w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">
                                <i data-lucide="map" class="w-4 h-4 mr-2"></i> ${t('viewOnMap')}
                            </a>
                        ` : `
                            <div class="text-center">
                                <i data-lucide="info" class="w-16 h-16 mx-auto text-warning"></i>
                                <p class="mt-4 text-lg font-semibold text-heading-light dark:text-heading-dark">No Active Vehicle</p>
                                <p class="mt-2 text-sm text-text-light dark:text-text-dark">${t('noActiveVehicle')}</p>
                            </div>
                        `}
                    </div>
                </div>`;
            }

            function renderSellView(user) {
                const t = AppState.t.bind(AppState);
                const userRequests = AppState.sellRequests.filter(r => r.householdId === user.householdId).sort((a,b) => new Date(b.date) - new Date(a.date));
                 const getStatusPill = (status) => {
                    const statusMap = {
                        'Completed': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
                        'Approved': 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300',
                        'Pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300',
                        'Rejected': 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'
                    };
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusMap[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
                };
                return `
                <div class="space-y-6 animate-fade-in-up">
                    <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                        <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark mb-1">Sell Your Recyclables</h2>
                        <p class="text-text-light dark:text-text-dark mb-6">Get paid for your segregated dry waste. Submit a request for pickup.</p>
                        <form id="sell-request-form" class="space-y-4">
                            <p class="text-sm font-medium text-text-light dark:text-text-dark">Enter weight in kilograms (kg):</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm">Plastic</label><input type="number" data-material="plastic" min="0" step="0.1" placeholder="e.g., 2.5" class="mt-1 w-full text-sm p-2 bg-transparent border-b border-border-light dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary"></div>
                                <div><label class="block text-sm">Paper</label><input type="number" data-material="paper" min="0" step="0.1" placeholder="e.g., 5" class="mt-1 w-full text-sm p-2 bg-transparent border-b border-border-light dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary"></div>
                                <div><label class="block text-sm">Glass</label><input type="number" data-material="glass" min="0" step="0.1" placeholder="e.g., 1.2" class="mt-1 w-full text-sm p-2 bg-transparent border-b border-border-light dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary"></div>
                                <div><label class="block text-sm">Steel</label><input type="number" data-material="steel" min="0" step="0.1" placeholder="e.g., 0.8" class="mt-1 w-full text-sm p-2 bg-transparent border-b border-border-light dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary"></div>
                            </div>
                            <div class="pt-2 border-t border-border-light dark:border-border-dark">
                                <p class="text-sm font-medium text-text-light dark:text-text-dark">${t('otherMaterial')}</p>
                                <div class="grid grid-cols-2 gap-4 mt-2">
                                     <div><label class="block text-xs">${t('materialName')}</label><input type="text" id="other-material-name" placeholder="e.g., Aluminum" class="mt-1 w-full text-sm p-2 bg-transparent border-b border-border-light dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary"></div>
                                     <div><label class="block text-xs">${t('weightKg')}</label><input type="number" id="other-material-weight" min="0" step="0.1" placeholder="e.g., 1.5" class="mt-1 w-full text-sm p-2 bg-transparent border-b border-border-light dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary"></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">Submit Request</button>
                        </form>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-heading-light dark:text-heading-dark mb-4">${t('mySellRequests')}</h3>
                        <div class="space-y-3">
                            ${userRequests.length > 0 ? userRequests.map(r => `
                                <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow-sm border border-border-light dark:border-border-dark">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-heading-light dark:text-heading-dark">Request on ${new Date(r.date).toLocaleDateString()}</p>
                                            <p class="text-sm text-secondary-dark">${r.weightKg} kg total</p>
                                        </div>
                                        ${getStatusPill(r.status)}
                                    </div>
                                    ${r.status === 'Approved' ? `
                                    <div class="mt-2 pt-2 border-t border-border-light dark:border-border-dark flex justify-between items-center">
                                       <p class="text-sm font-medium">Est. Value: <span class="text-success">₹${r.estimatedCost.toFixed(2)}</span></p>
                                       <button data-action="view-sell-chat" data-request-id="${r.id}" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">${t('chatWithAdmin')}</button>
                                    </div>
                                    `: ''}
                                </div>
                            `).join('') : `<p class="text-center text-text-light dark:text-text-dark py-4">${t('noSellRequests')}</p>`}
                        </div>
                    </div>
                </div>
                `;
            }

            function renderPaymentView(user) {
                const t = AppState.t.bind(AppState);
                const amountDue = user.outstandingBalance;
                const upiUrl = generateUpiUrl(amountDue, `Payment for ${user.householdId}`);
                return `
                <div class="space-y-6 animate-fade-in-up">
                     <h2 class="text-2xl font-bold text-heading-light dark:text-heading-dark">Make a Payment</h2>
                     <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-md border border-border-light dark:border-border-dark">
                        <div class="text-center mb-6">
                            <p class="text-sm text-text-light dark:text-text-dark">Amount Due</p>
                            <p class="text-5xl font-bold text-danger mt-1">₹${amountDue.toFixed(2)}</p>
                        </div>

                        ${amountDue > 0 ? `
                        <div class="space-y-4">
                            <a href="${upiUrl}" class="block w-full text-center bg-primary text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">
                                Pay with UPI App
                            </a>
                            <button data-action="generate-qr" class="w-full bg-secondary text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-secondary/80 transition">
                                Generate QR Code
                            </button>
                            <div id="qr-code-container" class="flex justify-center my-4"></div>

                            <div class="mt-8 pt-6 border-t border-border-light dark:border-border-dark">
                                <h3 class="font-semibold text-center text-heading-light dark:text-heading-dark">Important: Upload Screenshot</h3>
                                <p class="text-xs text-center text-secondary-dark mb-4">After payment, please upload a screenshot for verification.</p>
                                <form id="payment-verification-form">
                                    <input type="file" id="payment-screenshot" required class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                                    <button type="submit" class="w-full mt-4 bg-accent text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-accent/80 transition">Submit for Verification</button>
                                </form>
                            </div>
                        </div>
                        ` : `
                        <div class="text-center py-8">
                            <i data-lucide="party-popper" class="w-16 h-16 mx-auto text-success"></i>
                            <p class="mt-4 text-lg font-semibold text-heading-light dark:text-heading-dark">All Dues Cleared!</p>
                            <p class="mt-1 text-sm text-text-light dark:text-text-dark">Thank you for your timely payment.</p>
                        </div>
                        `}
                     </div>
                </div>
                `;
            }
            
            function renderModal(title, contentHTML, size = 'md') {
                const sizeMap = { 'md': 'max-w-md', 'lg': 'max-w-lg', 'xl': 'max-w-xl' };
                AppState.isModalOpen = true;
                const modalContainer = document.getElementById('modal-container');
                if (!modalContainer) return;
                modalContainer.innerHTML = `
                <div class="modal-overlay" id="modal-overlay">
                    <div class="modal-content bg-card-light dark:bg-card-dark rounded-xl shadow-2xl w-full ${sizeMap[size]} border border-border-light dark:border-border-dark">
                        <div class="flex justify-between items-center p-4 border-b border-border-light dark:border-border-dark">
                            <h3 class="text-lg font-bold text-heading-light dark:text-heading-dark">${title}</h3>
                            <button id="close-modal-btn" class="p-1 rounded-full text-secondary-dark hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-6">${contentHTML}</div>
                    </div>
                </div>`;
                document.getElementById('close-modal-btn').onclick = () => closeModal();
                document.getElementById('modal-overlay').onclick = (e) => { if(e.target.id === 'modal-overlay') closeModal(); };
                lucide.createIcons();
            }

            function closeModal() {
                AppState.isModalOpen = false;
                const modalContainer = document.getElementById('modal-container');
                if(modalContainer) modalContainer.innerHTML = '';
            }

            function renderProfileEditModal(user) {
                const t = AppState.t.bind(AppState);
                const content = `
                <form id="edit-profile-form" class="space-y-4 text-sm">
                     <div><label for="edit-name" class="block font-medium text-text-light dark:text-text-dark">${t('fullName')}</label><input type="text" id="edit-name" value="${escapeHTML(user.name)}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                     <div><label for="edit-email" class="block font-medium text-text-light dark:text-text-dark">${t('emailAddress')}</label><input type="email" id="edit-email" value="${escapeHTML(user.email)}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                     <div><label for="edit-area" class="block font-medium text-text-light dark:text-text-dark">${t('area')}</label><input type="text" id="edit-area" value="${escapeHTML(user.address.area)}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                     <div><label for="edit-landmark" class="block font-medium text-text-light dark:text-text-dark">${t('landmark')}</label><input type="text" id="edit-landmark" value="${escapeHTML(user.address.landmark)}" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                     <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">${t('saveChanges')}</button>
                </form>
                `;
                renderModal(t('editYourProfile'), content);
                document.getElementById('edit-profile-form').onsubmit = handleProfileEditSubmit;
            }
            
            function renderAddStaffModal() {
                const t = AppState.t.bind(AppState);
                const content = `
                <form id="add-staff-form" class="space-y-4 text-sm">
                     <div><label for="staff-name" class="block font-medium text-text-light dark:text-text-dark">${t('fullName')}</label><input type="text" id="staff-name" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                     <div><label for="staff-identifier" class="block font-medium text-text-light dark:text-text-dark">${t('mobileNumber')}</label><input type="tel" id="staff-identifier" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                     <div>
                        <label for="staff-role" class="block font-medium text-text-light dark:text-text-dark">${t('staffRole')}</label>
                        <select id="staff-role" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                            <option value="captain">${t('role_captain')}</option>
                            <option value="employee">${t('role_employee')}</option>
                            <option value="sanitaryworker">${t('role_sanitaryworker')}</option>
                        </select>
                     </div>
                     <div><label for="staff-password" class="block font-medium text-text-light dark:text-text-dark">${t('password')}</label><input type="password" id="staff-password" required class="mt-1 block w-full px-3 py-2 bg-transparent border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></div>
                     <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark transition">${t('addStaff')}</button>
                </form>
                `;
                renderModal(t('addStaffMember'), content);
                document.getElementById('add-staff-form').onsubmit = handleAddStaffSubmit;
            }

            function renderSellRequestChatModal(requestId) {
                const request = AppState.sellRequests.find(r => r.id === requestId);
                const user = AppState.users.find(u => u.householdId === request.householdId);
                const messages = AppState.sellRequestMessages.filter(m => m.sellRequestId === requestId).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                const currentUserRole = AppState.currentUser().role === 'admin' ? 'admin' : 'user';

                const chatContent = messages.map(msg => `
                    <div class="chat-message flex ${msg.sender === currentUserRole ? 'justify-end' : 'justify-start'} mb-2">
                        <div class="px-3 py-2 rounded-lg max-w-xs ${msg.sender === currentUserRole ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-text-light dark:text-text-dark'}">
                            <p class="text-sm">${escapeHTML(msg.text)}</p>
                            <p class="text-xs opacity-70 text-right mt-1">${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>
                `).join('');

                const content = `
                <div class="flex flex-col h-96">
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-2 hide-scrollbar">${chatContent}</div>
                    <form id="sell-chat-form" data-request-id="${requestId}" class="p-2 border-t border-border-light dark:border-border-dark flex items-center">
                        <input type="text" id="chat-input" required class="flex-grow bg-transparent border border-border-light dark:border-border-dark rounded-l-md p-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Type a message...">
                        <button type="submit" class="bg-primary text-white p-2 rounded-r-md"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </form>
                </div>`;
                renderModal(`Chat for Request #${requestId.slice(-4)}`, content);
                const chatMessagesDiv = document.getElementById('chat-messages');
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                document.getElementById('sell-chat-form').onsubmit = handleSellChatMessageSubmit;
            }
            
            function renderAppSkeleton(headerHTML, mainContentHTML, bottomNavHTML) {
                return `
                <div class="w-full max-w-lg mx-auto bg-background-light dark:bg-background-dark shadow-2xl flex flex-col h-screen font-sans">
                    ${headerHTML}
                    <main id="main-content" class="flex-grow p-4 md:p-6 overflow-y-auto pb-24 bg-transparent hide-scrollbar">
                        ${mainContentHTML}
                    </main>
                    ${bottomNavHTML}
                </div>
                `;
            }
            
            // =================================================================
            // 7. MAIN APP LOGIC & ROUTER
            // =================================================================
            let currentChartInstance = null;
            const centerTextPlugin = {
                id: 'centerText',
                afterDraw: (chart) => {
                    if (chart.config.options.plugins.centerText?.display) {
                        const ctx = chart.ctx;
                        const { top, left, width, height } = chart.chartArea;
                        const centerX = left + width / 2;
                        const centerY = top + height / 2;

                        const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);

                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        ctx.font = `bold ${width / 5}px sans-serif`;
                        ctx.fillStyle = AppState.theme === 'dark' ? '#f1f5f9' : '#1e293b';
                        ctx.fillText(total, centerX, centerY - (height / 14));

                        ctx.font = `normal ${width / 14}px sans-serif`;
                        ctx.fillStyle = AppState.theme === 'dark' ? '#94a3b8' : '#64748b';
                        ctx.fillText('Tons Diverted', centerX, centerY + (height / 12));

                        ctx.restore();
                    }
                }
            };
            
            function render() {
                const user = AppState.currentUser();
                let html = '';
                const t = AppState.t.bind(AppState);

                if (currentChartInstance) {
                    currentChartInstance.destroy();
                    currentChartInstance = null;
                }
                
                if (AppState.isModalOpen && document.getElementById('modal-container')?.hasChildNodes()) {
                    return; 
                }
                closeModal();

                if (user && user.role === 'admin' && localStorage.getItem('isAdminMode') === 'true') {
                    appRoot.className = `min-h-screen font-sans transition-colors duration-300 ${AppState.theme}`;
                    html = renderAdminApp();
                } 
                else if (!user) {
                   appRoot.className = `flex flex-col items-center justify-center min-h-screen p-4 font-sans transition-colors duration-300
                                        bg-gradient-to-br from-primary via-accent to-purple-500 dark:from-slate-900 dark:to-background-dark
                                        bg-400 animate-background-pan ${AppState.theme}`;
                   switch (AppState.loginMode) {
                        case 'user': html = renderAuthFlow(); break;
                        case 'admin': html = renderAdminAuthFlow(); break;
                        case 'staff': html = renderStaffAuthFlow(); break;
                        case 'selector':
                        default: html = renderLoginSelector(); break;
                   }
                } 
                else {
                    appRoot.className = `min-h-screen font-sans transition-colors duration-300 ${AppState.theme} bg-background-light dark:bg-background-dark`;
                    
                    if (['employee', 'captain', 'sanitaryworker'].includes(user.role)) {
                        html = renderStaffApp(user);
                    } else { // Household user
                        let mainContent = 'Loading...';
                        switch(AppState.currentView) {
                            case ViewType.Booking: mainContent = renderBookingView(user); break;
                            case ViewType.Complaints: mainContent = renderComplaintsView(user); break;
                            case ViewType.History: mainContent = renderHistoryView(user); break;
                            case ViewType.Profile: mainContent = renderProfileView(user); break;
                            case ViewType.Track: mainContent = renderTrackView(user); break;
                            case ViewType.Sell: mainContent = renderSellView(user); break;
                            case ViewType.Payment: mainContent = renderPaymentView(user); break;
                            case ViewType.Dashboard:
                            default:
                                const userBookings = AppState.bookings.filter(b => b.householdId === user.householdId);
                                mainContent = renderDashboard(user, userBookings);
                                break;
                        }
                        const bottomNavHTML = renderBottomNav(AppState.currentView);
                        html = renderAppSkeleton(renderHeader(user), mainContent, bottomNavHTML);
                    }
                }

                appRoot.innerHTML = html;
                lucide.createIcons();
                bindEventListeners(); 
                
                if (user && user.role === 'household') {
                     if (AppState.currentView === ViewType.Dashboard) {
                        // Show broadcast message if available and not seen
                        const broadcastSeen = sessionStorage.getItem('broadcast-seen');
                        if (AppState.broadcastMessage && broadcastSeen !== AppState.broadcastMessage) {
                            renderModal("Admin Announcement", `<p>${escapeHTML(AppState.broadcastMessage)}</p>`);
                            sessionStorage.setItem('broadcast-seen', AppState.broadcastMessage);
                        }

                        const pieChartCanvas = document.getElementById('community-pie-chart');
                        if (pieChartCanvas) {
                            const communityData = [{ name: 'Recycled', value: 78, color: '#34d399' }, { name: 'Composted', value: 45, color: '#fbbf24' }, { name: 'Landfill', value: 12, color: '#f87171' }];
                            currentChartInstance = new Chart(pieChartCanvas.getContext('2d'), {
                                type: 'doughnut',
                                plugins: [centerTextPlugin],
                                data: {
                                    labels: communityData.map(d => AppState.t(d.name.toLowerCase())),
                                    datasets: [{ data: communityData.map(d => d.value), backgroundColor: communityData.map(d => d.color), borderWidth: 2, borderColor: AppState.theme === 'dark' ? '#1e293b' : '#ffffff', hoverOffset: 15, hoverBorderColor: AppState.theme === 'dark' ? '#334155' : '#e2e8f0', hoverBorderWidth: 4 }]
                                },
                                options: { 
                                    responsive: true, 
                                    maintainAspectRatio: false, 
                                    cutout: '70%', 
                                    animation: { animateScale: true, animateRotate: true },
                                    plugins: { 
                                        legend: { display: false }, 
                                        tooltip: { enabled: true, backgroundColor: AppState.theme === 'dark' ? '#333' : '#333', titleColor: '#fff', bodyColor: '#fff', cornerRadius: 8, padding: 10,
                                            callbacks: { label: (context) => `${context.label}: ${context.raw} Tons` }
                                        },
                                        centerText: { display: true }
                                    } 
                                }
                            });
                            const legendContainer = document.getElementById('pie-chart-legend');
                            if(legendContainer) {
                                legendContainer.innerHTML = communityData.map(entry => `
                                    <div class="flex items-center justify-between text-sm transition-colors hover:bg-primary/5 p-1 rounded-md">
                                        <div class="flex items-center">
                                        <span class="w-3 h-3 rounded-full mr-3 flex-shrink-0" style="background-color: ${entry.color}"></span>
                                        <span class="text-text-light dark:text-text-dark">${AppState.t(entry.name.toLowerCase())}</span>
                                        </div>
                                        <span class="font-bold text-heading-light dark:text-heading-dark">${entry.value} Tons</span>
                                    </div>`).join('');
                            }
                        }
                    }
                } else if (user && ['employee', 'captain', 'sanitaryworker'].includes(user.role)) {
                    // Show staff broadcast message
                    const noticeSeen = sessionStorage.getItem('staff-notice-seen');
                    if (AppState.staffBroadcastMessage && noticeSeen !== AppState.staffBroadcastMessage) {
                        renderModal(t('aMessageForYou'), `<p>${escapeHTML(AppState.staffBroadcastMessage)}</p>`);
                        sessionStorage.setItem('staff-notice-seen', AppState.staffBroadcastMessage);
                    }
                }
            }

            // =================================================================
            // 8. EVENT LISTENERS & HANDLERS
            // =================================================================
            function stopLocationTracking() {
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
            }

            function startLocationTracking() {
                if (locationWatchId) return; // Already tracking

                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by your browser.');
                    return;
                }

                locationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const currentUser = AppState.currentUser();
                        if (currentUser) {
                            AppState.updateUserLocation(currentUser.householdId, { lat: latitude, lng: longitude });
                        }
                    },
                    (error) => {
                        console.error('Geolocation Error:', error);
                        if (error.code === error.PERMISSION_DENIED) {
                            alert('Location permission denied. You must enable it to start your work day.');
                            stopLocationTracking();
                            render(); // re-render to update button state
                        }
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }

            function bindEventListeners() {
                appRoot.onclick = (e) => {
                    const viewTarget = e.target.closest('[data-view]');
                    if (viewTarget) { AppState.currentView = viewTarget.dataset.view; render(); }
                    
                    const adminViewTarget = e.target.closest('[data-adminview]');
                    if (adminViewTarget) { AppState.currentAdminView = adminViewTarget.dataset.adminview; render(); }

                    const loginTypeTarget = e.target.closest('[data-logintype]');
                    if (loginTypeTarget) { AppState.loginMode = loginTypeTarget.dataset.logintype; render(); }
                    
                    const authActionTarget = e.target.closest('[data-authaction]');
                    if (authActionTarget) handleAuthAction(authActionTarget.dataset.authaction);

                    const appAction = e.target.closest('[data-action]');
                    if(appAction) handleAppAction(appAction, appAction.dataset.action);

                    const bookingAction = e.target.closest('[data-booking-action]');
                    if (bookingAction) {
                        const action = bookingAction.dataset.bookingAction;
                        const id = bookingAction.dataset.bookingId;
                        const booking = AppState.bookings.find(b => b.id === id);
                        if (booking) {
                           if(action === 'approve') AppState.updateBooking({ ...booking, status: 'Scheduled' });
                           if(action === 'reject') AppState.updateBooking({ ...booking, status: 'Rejected' });
                           render();
                        }
                    }

                    const passwordToggle = e.target.closest('[data-password-toggle]');
                    if (passwordToggle) {
                        const userId = passwordToggle.dataset.passwordToggle;
                        const passInput = document.getElementById(`pass-${userId}`);
                        const icon = passwordToggle.querySelector('i');
                        if (passInput.type === 'password') {
                            passInput.type = 'text';
                            icon.setAttribute('data-lucide', 'eye-off');
                        } else {
                            passInput.type = 'password';
                            icon.setAttribute('data-lucide', 'eye');
                        }
                        lucide.createIcons({
                            nodes: [icon]
                        });
                    }

                    if (e.target.closest('#theme-toggle-btn')) AppState.toggleTheme();
                    if (e.target.closest('#theme-toggle-btn-auth')) AppState.toggleTheme();
                    if (e.target.closest('#logout-btn')) { AppState.logout(); render(); }
                    if (e.target.closest('#profile-pic-btn')) document.getElementById('profile-pic-upload').click();

                    if (e.target.closest('#toggle-tracking-btn')) {
                        if (locationWatchId) {
                            stopLocationTracking();
                        } else {
                            startLocationTracking();
                        }
                        render(); // Re-render to update the button text and status indicator
                    }
                };
                 appRoot.onchange = (e) => {
                    if (e.target.id === 'language-switcher-header') { AppState.setLanguage(e.target.value); render(); }
                    if (e.target.id === 'language-switcher-auth') { AppState.setLanguage(e.target.value); render(); }
                    if (e.target.id === 'profile-pic-upload') handleProfilePictureChange(e.target);
                    if (e.target.id === 'user-role-filter') handleUserFilter();
                    const complaintAction = e.target.closest('[data-complaint-action]');
                    if (complaintAction) {
                        const action = complaintAction.dataset.complaintAction;
                        const id = complaintAction.dataset.complaintId;
                        const complaint = AppState.complaints.find(c => c.id === id);
                        if (complaint && action === 'status') {
                           AppState.updateComplaint({ ...complaint, status: e.target.value });
                           render();
                        }
                    }
                };
                appRoot.onsubmit = (e) => {
                    e.preventDefault();
                    if (e.target.id === 'login-form') handleLoginSubmit(e.target);
                    if (e.target.id === 'staff-login-form') handleStaffLoginSubmit(e.target);
                    if (e.target.id === 'signup-step1-form') handleSignupStep1Submit(e.target);
                    if (e.target.id === 'signup-step2-form') handleSignupStep2Submit(e.target);
                    if (e.target.id === 'admin-send-otp-form') handleAdminSendOtp(e.target);
                    if (e.target.id === 'admin-verify-otp-form') handleAdminVerifyOtp(e.target);
                    if (e.target.id === 'booking-form') handleBookingSubmit(e.target);
                    if (e.target.id === 'complaint-form') handleComplaintSubmit(e.target);
                    if (e.target.id === 'feedback-form') handleFeedbackSubmit(e.target);
                    if (e.target.id === 'broadcast-form') handleBroadcastSubmit(e.target);
                    if (e.target.id === 'sell-request-form') handleSellRequestSubmit(e.target);
                    if (e.target.id === 'payment-verification-form') handlePaymentVerificationSubmit(e.target);
                    const formAction = e.target.dataset.action;
                    if (formAction === 'approve-sell-request') handleApproveSellRequest(e.target);
                };
                appRoot.oninput = (e) => {
                    if (e.target.id === 'password' && AppState.authFlowState.isSignup) {
                        const password = e.target.value;
                        AppState.authFlowState.formData.password = password;
                        AppState.authFlowState.passwordStrength = AppState.calculatePasswordStrength(password);
                        const container = document.getElementById('password-strength-container');
                        if (container) {
                            container.innerHTML = renderPasswordStrengthIndicator(AppState.authFlowState.passwordStrength, password);
                            lucide.createIcons();
                        }
                    }
                    if (e.target.id === 'user-search-input') handleUserFilter();
                };
            }

            function handleUserFilter() {
                const searchInput = document.getElementById('user-search-input');
                const roleFilter = document.getElementById('user-role-filter');
                if (!searchInput || !roleFilter) return;

                const searchTerm = searchInput.value.toLowerCase();
                const roleTerm = roleFilter.value;
                const userCards = document.querySelectorAll('.user-card');

                userCards.forEach(card => {
                    const name = card.dataset.name;
                    const id = card.dataset.id;
                    const role = card.dataset.role;

                    const matchesSearch = name.includes(searchTerm) || id.includes(searchTerm);
                    const matchesRole = roleTerm === '' || role === roleTerm;

                    if (matchesSearch && matchesRole) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            function handleAppAction(element, action) {
                switch(action) {
                    case 'edit-profile': renderProfileEditModal(AppState.currentUser()); break;
                    case 'add-staff': renderAddStaffModal(); break;
                    case 'generate-qr': handleGenerateQrCode(); break;
                    case 'view-screenshot': renderModal('Payment Screenshot', `<img src="${AppState.payments.find(p => p.id === element.dataset.paymentId).screenshot}" alt="Payment Screenshot">`); break;
                    case 'approve-payment': handlePaymentApproval(element.dataset.paymentId, true); break;
                    case 'reject-payment': handlePaymentApproval(element.dataset.paymentId, false); break;
                    case 'view-sell-chat': renderSellRequestChatModal(element.dataset.requestId); break;
                    case 'complete-sell-request': handleCompleteSellRequest(element.dataset.requestId); break;
                    case 'log-waste': handleWasteLog(element.dataset.wasteType); break;
                    case 'download-history': handleDownloadHistory(); break;
                    case 'toggle-push': handleTogglePush(); break;
                    case 'watch-ad-btn': renderModal('Advertisement', '<video width="100%" autoplay controls><source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">Your browser does not support the video tag.</video>'); break;
                    case 'admin-edit-user':
                        const userToEdit = AppState.users.find(u => u.householdId === element.dataset.userId);
                        if(userToEdit) renderAdminUserEditModal(userToEdit);
                        break;
                    case 'admin-toggle-block':
                        const userToBlock = AppState.users.find(u => u.householdId === element.dataset.userId);
                        if (userToBlock) {
                            userToBlock.status = userToBlock.status === 'active' ? 'blocked' : 'active';
                            AppState.updateUser(userToBlock);
                            render();
                        }
                        break;
                    case 'admin-message-user': alert('Messaging feature coming soon!'); break;
                }
            }
            
            function handleAuthAction(action) {
                const { authFlowState } = AppState;
                authFlowState.error = null; // Clear error on action
                switch(action) {
                    case 'show-login': authFlowState.isSignup = false; break;
                    case 'show-signup': authFlowState.isSignup = true; authFlowState.step = 1; break;
                    case 'back-to-selector': AppState.loginMode = 'selector'; authFlowState.otpSent = false; break;
                    case 'back-to-step1': authFlowState.step = 1; break;
                    case 'admin-change-identifier': authFlowState.otpSent = false; authFlowState.otpIdentifier = ''; break;
                    case 'admin-resend-otp': AppState.sendAdminOtp(authFlowState.otpIdentifier); break;
                }
                render();
            }

            function handleLoginSubmit(form) {
                const identifier = form.elements.identifier.value;
                const password = form.elements.password.value;
                const rememberMe = form.elements['remember-me'].checked;
                const result = AppState.login(identifier, password, rememberMe);
                if (result.success) {
                    render();
                } else {
                    AppState.authFlowState.error = result.message;
                    render();
                }
            }
            
            function handleStaffLoginSubmit(form) {
                const identifier = form.elements['staff-identifier'].value;
                const result = AppState.loginAsStaff(identifier);
                if (result.success) {
                    render();
                } else {
                    AppState.authFlowState.error = result.message;
                    render();
                }
            }

            function handleAdminSendOtp(form) {
                const identifier = form.elements['admin-identifier'].value;
                const result = AppState.sendAdminOtp(identifier);
                if (!result.success) {
                    AppState.authFlowState.error = result.message;
                }
                render();
            }

            function handleAdminVerifyOtp(form) {
                const otp = form.elements['admin-otp'].value;
                const result = AppState.verifyAdminOtpAndLogin(otp);
                 if (result.success) {
                    render();
                } else {
                    AppState.authFlowState.error = result.message;
                    render();
                }
            }

            function handleSignupStep1Submit(form) {
                const { authFlowState } = AppState;
                const password = form.elements.password.value;
                const confirmPassword = form.elements.confirmPassword.value;
                const email = form.elements.email.value.trim();
                const identifier = form.elements.identifier.value.trim();

                if (AppState.users.some(u => u.identifier === identifier)) {
                    authFlowState.error = 'An account with this mobile number already exists.';
                } else if (AppState.users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
                    authFlowState.error = 'An account with this email address already exists.';
                } else if (password !== confirmPassword) {
                    authFlowState.error = "Passwords do not match.";
                } else if (!AppState.isStrongPassword(password)) {
                     authFlowState.error = "Password is not strong enough. Please meet all criteria.";
                } else {
                    authFlowState.error = null;
                    authFlowState.formData = {
                        ...authFlowState.formData,
                        name: form.elements.fullName.value,
                        identifier: identifier,
                        email: email,
                        password: password,
                    };
                    authFlowState.step = 2;
                }
                render();
            }

            function handleSignupStep2Submit(form) {
                 const { authFlowState } = AppState;
                 const signupData = {
                     ...authFlowState.formData,
                     familySize: form.elements.familySize.value,
                     gramPanchayat: form.elements.gramPanchayat.value,
                     address: {
                        area: form.elements.area.value,
                        landmark: form.elements.landmark.value,
                        pincode: form.elements.pincode.value,
                     }
                 };
                 const result = AppState.signup(signupData);
                 if (result.success) {
                    authFlowState.isSignup = false;
                    authFlowState.step = 1;
                    authFlowState.formData = {};
                    render();
                 } else {
                    authFlowState.error = result.message;
                    authFlowState.step = 1;
                    render();
                 }
            }
            
            function handleBookingSubmit(form) {
                const newBooking = {
                    id: `BK-${Date.now()}`,
                    householdId: AppState.loggedInUserId,
                    wasteType: form.elements['waste-type'].value,
                    date: form.elements['booking-date'].value,
                    timeSlot: form.elements['time-slot'].value,
                    notes: form.elements['booking-notes'].value,
                    status: 'Pending Approval',
                };
                AppState.addBooking(newBooking);
                form.reset();
                render();
                alert('Your booking request has been submitted for approval!');
            }

            function handleComplaintSubmit(form) {
                const newComplaint = {
                    id: `CMPT-${Date.now()}`,
                    householdId: AppState.loggedInUserId,
                    issue: form.elements['issue-type'].value,
                    details: form.elements['complaint-details'].value,
                    date: new Date(),
                    status: 'Pending',
                };
                AppState.addComplaint(newComplaint);
                form.reset();
                render();
                alert('Your complaint has been filed. We will look into it shortly.');
            }
            
            function handleProfileEditSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const user = AppState.currentUser();
                const updatedUser = {
                    ...user,
                    name: form.elements['edit-name'].value,
                    email: form.elements['edit-email'].value,
                    address: {
                        ...user.address,
                        area: form.elements['edit-area'].value,
                        landmark: form.elements['edit-landmark'].value,
                    }
                };
                AppState.updateUser(updatedUser);
                closeModal();
                render();
            }

            function handleProfilePictureChange(input) {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const user = AppState.currentUser();
                        AppState.updateUser({ ...user, profilePicture: e.target.result });
                        render();
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            function handleFeedbackSubmit(form) {
                 const t = AppState.t.bind(AppState);
                 alert(t('feedbackThanks'));
                 form.reset();
            }
            
            function handleBroadcastSubmit(form) {
                const message = form.elements['broadcast-message'].value;
                AppState.updateBroadcastMessage(message);
                alert('Broadcast message updated successfully!');
                render();
            }

            function handleSellRequestSubmit(form) {
                const inputs = form.querySelectorAll('input[data-material]');
                let totalWeight = 0;
                const materials = {};
                inputs.forEach(input => {
                    const weight = parseFloat(input.value);
                    if (weight > 0) {
                        materials[input.dataset.material] = weight;
                        totalWeight += weight;
                    }
                });
                
                const otherName = form.elements['other-material-name'].value.trim();
                const otherWeight = parseFloat(form.elements['other-material-weight'].value);
                if (otherName && otherWeight > 0) {
                    materials[otherName] = otherWeight;
                    totalWeight += otherWeight;
                }

                if (totalWeight === 0) {
                    alert('Please enter the weight for at least one material.');
                    return;
                }
                const newRequest = {
                    id: `SELL-${Date.now()}`,
                    householdId: AppState.loggedInUserId,
                    date: new Date(),
                    materials: materials,
                    weightKg: totalWeight,
                    status: 'Pending',
                    estimatedCost: 0,
                };
                AppState.addSellRequest(newRequest);
                form.reset();
                render();
                alert('Your sell request has been submitted!');
            }

            function handleApproveSellRequest(form) {
                const requestId = form.dataset.requestId;
                const cost = parseFloat(form.elements[`cost-${requestId}`].value);
                if (isNaN(cost) || cost <= 0) {
                    alert('Please enter a valid estimated cost.');
                    return;
                }
                const request = AppState.sellRequests.find(r => r.id === requestId);
                if(request) {
                    AppState.updateSellRequest({ ...request, status: 'Approved', estimatedCost: cost });
                    render();
                }
            }

            function handleSellChatMessageSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const requestId = form.dataset.requestId;
                const input = form.elements['chat-input'];
                const text = input.value.trim();
                if (text) {
                    const newMessage = {
                        sellRequestId: requestId,
                        sender: AppState.currentUser().role === 'admin' ? 'admin' : 'user',
                        text: text,
                    };
                    AppState.addSellRequestMessage(newMessage);
                    input.value = '';
                    renderSellRequestChatModal(requestId); // Re-render only the modal
                }
            }

            function handleCompleteSellRequest(requestId) {
                const request = AppState.sellRequests.find(r => r.id === requestId);
                if (request) {
                    AppState.updateSellRequest({ ...request, status: 'Completed' });
                    render();
                }
            }
            
            function handleAddStaffSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const name = form.elements['staff-name'].value;
                const identifier = form.elements['staff-identifier'].value;
                const role = form.elements['staff-role'].value;
                const password = form.elements['staff-password'].value;

                if (AppState.users.some(u => u.identifier === identifier)) {
                    alert('A user with this mobile number already exists.');
                    return;
                }
                if (!AppState.isStrongPassword(password)) {
                    alert('Password is not strong enough. It must have 8+ chars, upper, lower, number, and special char.');
                    return;
                }

                const rolePrefix = { captain: 'CPT', employee: 'EMP', sanitaryworker: 'SNW' }[role] || 'STF';
                const householdId = `${rolePrefix}-${name.slice(0, 4).toUpperCase()}-${Date.now().toString().slice(-4)}`;

                const newStaffMember = {
                    name,
                    householdId,
                    identifier,
                    password,
                    role,
                    status: 'active',
                    email: `${identifier}@staff.com`,
                    createdAt: new Date(),
                    outstandingBalance: 0,
                    familySize: 1,
                    address: {},
                    gramPanchayat: 'ANDAL',
                };
                
                AppState.addUser(newStaffMember);
                alert('Staff member added successfully!');
                closeModal();
                render();
            }

            function handleGenerateQrCode() {
                const container = document.getElementById('qr-code-container');
                const amount = AppState.currentUser().outstandingBalance;
                if (container && amount > 0) {
                    container.innerHTML = '';
                    const upiUrl = generateUpiUrl(amount, `Payment for ${AppState.currentUser().householdId}`);
                    QRCode.toCanvas(upiUrl, { width: 200, margin: 2 }, function (error, canvas) {
                        if (error) console.error(error);
                        container.appendChild(canvas);
                    });
                }
            }

            function handlePaymentVerificationSubmit(form) {
                const screenshotInput = form.elements['payment-screenshot'];
                if (!screenshotInput.files || screenshotInput.files.length === 0) {
                    alert('Please upload a payment screenshot.');
                    return;
                }
                const file = screenshotInput.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newPayment = {
                        id: `TXN-${Date.now()}`,
                        householdId: AppState.loggedInUserId,
                        date: new Date(),
                        amount: AppState.currentUser().outstandingBalance,
                        status: 'Pending Verification',
                        screenshot: e.target.result
                    };
                    AppState.addPayment(newPayment);
                    alert('Payment submitted for verification. It will be reflected in your account upon approval.');
                    render();
                };
                reader.readAsDataURL(file);
            }
            
            function handlePaymentApproval(paymentId, isApproved) {
                const payment = AppState.payments.find(p => p.id === paymentId);
                const user = AppState.users.find(u => u.householdId === payment.householdId);
                if (payment && user) {
                    const newStatus = isApproved ? 'Paid' : 'Rejected';
                    AppState.updatePayment({ ...payment, status: newStatus });
                    if(isApproved) {
                        AppState.updateUser({ ...user, outstandingBalance: Math.max(0, user.outstandingBalance - payment.amount) });
                    }
                    render();
                }
            }
            
            function handleWasteLog(wasteType) {
                const user = AppState.currentUser();
                const todayStr = new Date().toISOString().split('T')[0];
                const hasLoggedToday = AppState.wasteLogs.some(log => 
                    log.householdId === user.householdId && 
                    new Date(log.date).toISOString().split('T')[0] === todayStr
                );

                if (hasLoggedToday) {
                    alert("You have already logged your waste for today.");
                    return;
                }

                const newLog = { householdId: user.householdId, type: wasteType, date: new Date() };
                AppState.addWasteLog(newLog);

                let consecutiveMixedLogs = user.consecutiveMixedLogs || 0;
                let outstandingBalance = user.outstandingBalance;

                if (wasteType === 'Mixed') {
                    consecutiveMixedLogs++;
                } else {
                    consecutiveMixedLogs = 0; // Reset counter
                }

                if (consecutiveMixedLogs >= 3) {
                    outstandingBalance += 100;
                    consecutiveMixedLogs = 0; // Reset after fine
                    const fineMessage = 'A fine of ₹100 has been added to your account for logging mixed waste on three consecutive days. Please ensure proper segregation.';
                    AppState.addMessage(user.householdId, fineMessage);
                    alert(fineMessage);
                }

                AppState.updateUser({ ...user, consecutiveMixedLogs, outstandingBalance });
                render();
            }

            function handleDownloadHistory() {
                const user = AppState.currentUser();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

                const userPayments = AppState.payments
                    .filter(p => p.householdId === user.householdId && new Date(p.date) >= oneYearAgo && p.status === 'Paid')
                    .sort((a,b) => new Date(b.date) - new Date(a.date));

                doc.setFontSize(18);
                doc.text('Payment History', 14, 22);
                doc.setFontSize(11);
                doc.text(`User: ${user.name} (${user.householdId})`, 14, 30);
                doc.text(`Date Generated: ${new Date().toLocaleDateString()}`, 14, 36);

                if (userPayments.length === 0) {
                    doc.text('No paid transactions found in the last year.', 14, 50);
                } else {
                    const tableData = userPayments.map(p => [
                        p.id,
                        new Date(p.date).toLocaleDateString(),
                        `Rs. ${p.amount.toFixed(2)}`,
                        p.status
                    ]);

                    doc.autoTable({
                        startY: 40,
                        head: [['Transaction ID', 'Date', 'Amount', 'Status']],
                        body: tableData,
                    });
                }
                
                doc.save(`EcoTrack_Payment_History_${user.householdId}.pdf`);
            }

            function handleTogglePush() {
                const user = AppState.currentUser();
                const updatedUser = { ...user, pushNotificationsEnabled: !user.pushNotificationsEnabled };
                AppState.updateUser(updatedUser);
                render();
            }

            function renderAdminUserEditModal(userToEdit) {
                 const t = AppState.t.bind(AppState);
                const content = `
                <form id="admin-edit-user-form" data-user-id="${userToEdit.householdId}" class="space-y-4 text-sm">
                     <div><label for="admin-edit-name" class="block font-medium">${t('fullName')}</label><input type="text" id="admin-edit-name" value="${escapeHTML(userToEdit.name)}" required class="mt-1 w-full p-2 bg-transparent border rounded-md"></div>
                     <div><label for="admin-edit-email" class="block font-medium">${t('emailAddress')}</label><input type="email" id="admin-edit-email" value="${escapeHTML(userToEdit.email)}" required class="mt-1 w-full p-2 bg-transparent border rounded-md"></div>
                     <div><label for="admin-edit-balance" class="block font-medium">${t('balance')}</label><input type="number" step="0.01" id="admin-edit-balance" value="${userToEdit.outstandingBalance}" required class="mt-1 w-full p-2 bg-transparent border rounded-md"></div>
                     <button type="submit" class="w-full bg-primary text-white font-bold py-2.5 px-4 rounded-lg">${t('saveChanges')}</button>
                </form>
                `;
                renderModal(`Edit User: ${userToEdit.name}`, content);
                document.getElementById('admin-edit-user-form').onsubmit = handleAdminUserEditSubmit;
            }

            function handleAdminUserEditSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const userId = form.dataset.userId;
                const user = AppState.users.find(u => u.householdId === userId);

                if (user) {
                    const updatedUser = {
                        ...user,
                        name: form.elements['admin-edit-name'].value,
                        email: form.elements['admin-edit-email'].value,
                        outstandingBalance: parseFloat(form.elements['admin-edit-balance'].value)
                    };
                    AppState.updateUser(updatedUser);
                    closeModal();
                    render();
                }
            }


            // =================================================================
            // 9. APP INITIALIZATION
            // =================================================================
            AppState.init();
            GeminiService.init();
            render();

        });
    </script>
</body>
</html>